<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§é˜ªæ¥µç°¡æ—…éŠæŒ‡å—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Muji/Minimalist Custom Styles */
        :root {
            --color-primary: #52734D; /* æŸ”å’Œè‹”ç¶  */
            --color-bg: #F9F9F9; /* ç±³ç™½è‰²èƒŒæ™¯ */
            --color-card-bg: #FFFFFF; /* å¡ç‰‡ç™½è‰² */
            --color-accent: #B2D4C8; /* æ·ºç¶ è‰²é»ç¶´ */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            padding-bottom: 4rem; /* ç¢ºä¿å…§å®¹ä¸æœƒè¢«åº•éƒ¨å°èˆªé®æ“‹ */
        }
        .muji-card {
            background-color: var(--color-card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .muji-btn {
            background-color: var(--color-primary);
            color: white;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .muji-btn:hover {
            background-color: #6a9562;
        }
        /* å°èˆªåˆ—æ¨£å¼ */
        .nav-item.active {
            color: var(--color-primary);
            font-weight: 600;
        }
        /* ç¢ºä¿å…§å®¹å€å¡Šä½”æ»¿è¦–çª— */
        .page-content {
            padding-top: 2rem;
            padding-bottom: 2rem;
            min-height: calc(100vh - 4rem - 2rem); /* 100vh - å°èˆªé«˜åº¦ - é ‚éƒ¨æ¨™é ­ */
        }
        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--color-accent);
        }
        .timeline-dot {
            position: absolute;
            left: -8px;
            top: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--color-primary);
            border: 3px solid var(--color-bg);
            z-index: 10;
        }
        .highlight-time {
            background-color: #ffedd5; /* æ·ºæ©™è‰²/ç±³é»ƒè‰²å¼·èª¿ */
            color: #c2410c; /* æ·±æ©˜è‰²æ–‡å­— */
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
        }
        /* éš±è—åŸç”Ÿæª”æ¡ˆè¼¸å…¥ï¼Œåƒ…é¡¯ç¤ºæŒ‰éˆ• */
        .hidden-file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
            pointer-events: none;
        }
        /* Modal æ¨£å¼ */
        .modal {
            display: none; /* é è¨­éš±è— */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(3px);
            padding-top: 50px;
        }
        .modal-content {
            background-color: var(--color-card-bg);
            margin: 5% auto; /* 5% from the top and centered */
            padding: 20px;
            border-radius: 12px;
            width: 90%; /* Responsive width */
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <header class="sticky top-0 bg-white shadow-sm p-4 z-20">
        <h1 id="app-title" class="text-xl font-bold text-center text-gray-800">
            å¤§é˜ªæ¥µç°¡æ—…éŠæŒ‡å—
        </h1>
        <p class="text-xs text-center text-gray-500 mt-1">
            <span id="current-user-id">Loading User...</span>
        </p>
    </header>

    <main id="content" class="p-4 page-content max-w-xl mx-auto">
        </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl z-30">
        <div class="flex justify-around items-center h-16 max-w-xl mx-auto">
            <button class="nav-item flex flex-col items-center p-2 active" data-page="plan">
                <i class="fas fa-map-marked-alt text-xl"></i>
                <span class="text-xs mt-1">è¡Œç¨‹</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-page="guide">
                <i class="fas fa-sun text-xl"></i>
                <span class="text-xs mt-1">å¤©æ°£/äº¤é€š</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-page="wallet">
                <i class="fas fa-wallet text-xl"></i>
                <span class="text-xs mt-1">è¨˜å¸³</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-page="lists">
                <i class="fas fa-list-check text-xl"></i>
                <span class="text-xs mt-1">æ¸…å–®</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-page="info">
                <i class="fas fa-info-circle text-xl"></i>
                <span class="text-xs mt-1">è³‡è¨Š</span>
            </button>
        </div>
    </nav>

    <div id="edit-item-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ç·¨è¼¯è¡Œç¨‹ç´°é …</h3>
            
            <input type="hidden" id="modal-mode"> <input type="hidden" id="modal-day-index">
            <input type="hidden" id="modal-item-index">
            
            <div class="mb-4">
                <label for="modal-time" class="block text-sm font-medium text-gray-700 mb-1">æ™‚é–“ (e.g., 10:00 / å…¨å¤©)</label>
                <input type="text" id="modal-time" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">
            </div>
            
            <div class="mb-4">
                <label for="modal-desc" class="block text-sm font-medium text-gray-700 mb-1">å…§å®¹æè¿°</label>
                <textarea id="modal-desc" class="w-full p-2 border border-gray-300 rounded-lg h-24 focus:ring-var(--color-primary) focus:border-var(--color-primary) resize-none"></textarea>
            </div>
            
            <div class="mb-4">
                <label for="modal-type" class="block text-sm font-medium text-gray-700 mb-1">é …ç›®é¡å‹ (å½±éŸ¿åœ–æ¨™ï¼Œe.g., visit, meal, shopping)</label>
                <input type="text" id="modal-type" placeholder="e.g., visit, meal, activity" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">
            </div>
            
            <div class="mb-4">
                <label for="modal-map" class="block text-sm font-medium text-gray-700 mb-1">åœ°åœ–æœå°‹é—œéµå­— (é¸å¡«)</label>
                <input type="text" id="modal-map" placeholder="e.g., å¤§é˜ªåŸå…¬åœ’" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">
            </div>
            
            <div class="mb-4 flex items-center">
                <input type="checkbox" id="modal-highlight" class="h-4 w-4 text-var(--color-primary) border-gray-300 rounded focus:ring-var(--color-primary)">
                <label for="modal-highlight" class="ml-2 text-sm font-medium text-gray-700">é‡é»é …ç›® (æ™‚é–“å°‡æœƒé«˜äº®é¡¯ç¤º)</label>
            </div>

            <div class="flex justify-between mt-6">
                <button id="delete-btn" onclick="deleteItem()" class="bg-red-500 text-white hover:bg-red-600 rounded-lg py-2 px-4 text-sm font-medium">
                    <i class="fas fa-trash-alt mr-1"></i> åˆªé™¤
                </button>
                <div class="flex space-x-3">
                    <button onclick="closeEditItemModal()" class="bg-gray-300 text-gray-800 hover:bg-gray-400 rounded-lg py-2 px-4 text-sm font-medium">å–æ¶ˆ</button>
                    <button onclick="saveEditedItem()" class="muji-btn py-2 px-4 text-sm font-medium">å„²å­˜/æ–°å¢</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-day-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ç·¨è¼¯æ¯æ—¥æ¨™é¡Œ</h3>
            
            <input type="hidden" id="day-modal-index">
            
            <div class="mb-4">
                <label for="day-modal-date" class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸæè¿° (e.g., 12/15 (ä¸€) Day1)</label>
                <input type="text" id="day-modal-date" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">
            </div>
            
            <div class="mb-4">
                <label for="day-modal-title" class="block text-sm font-medium text-gray-700 mb-1">è¡Œç¨‹æ¨™é¡Œ (e.g., æŠµé”èˆ‡å…¥ä½å¿ƒé½‹æ©‹)</label>
                <input type="text" id="day-modal-title" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button onclick="closeEditDayModal()" class="bg-gray-300 text-gray-800 hover:bg-gray-400 rounded-lg py-2 px-4 text-sm font-medium">å–æ¶ˆ</button>
                <button onclick="saveEditedDay()" class="muji-btn py-2 px-4 text-sm font-medium">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>
    
    <div id="reset-confirm-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-red-600 mb-4 border-b pb-2">âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ</h3>
            
            <p class="text-gray-700 mb-4">
                æ‚¨å³å°‡æ¸…é™¤ç€è¦½å™¨ä¸­**æ‰€æœ‰**å„²å­˜çš„è¡Œç¨‹ã€è¨˜å¸³ã€æ¸…å–®ç­‰è³‡æ–™ã€‚
            </p>
            <p class="font-bold text-red-600 mb-6">
                æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹ç¢ºèªæ‚¨å·²ç¶“å‚™ä»½é‡è¦è³‡è¨Šï¼
            </p>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button onclick="closeResetConfirmModal()" class="bg-gray-300 text-gray-800 hover:bg-gray-400 rounded-lg py-2 px-4 text-sm font-medium">å–æ¶ˆ</button>
                <button onclick="executeReset()" class="muji-btn bg-red-600 hover:bg-red-700 py-2 px-4 text-sm font-medium">
                    <i class="fas fa-trash-alt mr-1"></i> ç¢ºèªæ¸…é™¤æ‰€æœ‰æ•¸æ“š
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // I. DATA & STATE MANAGEMENT
        // ====================================================================

        let currentPage = 'plan';
        let userId = 'user-' + Math.random().toString(36).substring(2, 9); // Simple unique ID for LocalStorage
        const LS_PREFIX = 'muji_travel_app_';

        // é è¨­åŒ¯ç‡: 1 JPY = 0.21 TWD
        const DEFAULT_EXCHANGE_RATE = 0.21;
        
        // æ—…ç¨‹éœæ…‹è³‡è¨Šçš„åŸå§‹è³‡æ–™ (ä½œç‚º Reset çš„å‚™ä»½)
        const initialTripInfo = {
            flight: [
                { type: "å»ç¨‹", date: "12/15 (ä¸€)", flightNo: "MM032", from: "å°æ¸¯æ©Ÿå ´ (KHH)", dep: "14:45", to: "å¤§é˜ªé—œè¥¿æ©Ÿå ´ (KIX-T2)", arr: "18:30" },
                { type: "å›ç¨‹", date: "12/20 (å…­)", flightNo: "MM031", from: "å¤§é˜ªé—œè¥¿æ©Ÿå ´ (KIX-T2)", dep: "11:05", to: "å°æ¸¯æ©Ÿå ´ (KHH)", arr: "13:50" }
            ],
            hotel: "VIA INN PRIME å¿ƒé½‹æ©‹å››æ©‹Hotel",
            days: [
                {
                    date: "12/15 (ä¸€) Day1",
                    title: "æŠµé”èˆ‡å…¥ä½å¿ƒé½‹æ©‹",
                    items: [
                        { time: "18:30", type: "arrival", desc: "æŠµé”å¤§é˜ªé—œè¥¿æ©Ÿå ´ï¼ˆç¬¬äºŒèˆªå»ˆï¼‰", highlight: true, map: "å¤§é˜ªé—œè¥¿åœ‹éš›æ©Ÿå ´" },
                        { time: "20:00", type: "meal", desc: "æ™šé¤ï¼šå¿ƒé½‹æ©‹å‘¨é‚Šç”¨é¤ï¼ˆè‡ªè¡Œæ±ºå®šï¼‰", highlight: true, map: "å¿ƒé½‹æ©‹ç­‹å•†åº—è¡—" }, 
                        { time: "21:30", type: "end", desc: "å…¥ä½ä¼‘æ¯", map: "VIA INN PRIME å¿ƒé½‹æ©‹å››æ©‹Hotel" },
                    ]
                },
                {
                    date: "12/16 (äºŒ) Day2",
                    title: "æ—¥æœ¬ç’°çƒå½±åŸğŸ‡¯ğŸ‡µ (USJ)",
                    items: [
                        { time: "å…¨å¤©", type: "activity", desc: "æ—¥æœ¬ç’°çƒå½±åŸéŠç©ï¼ˆç’°çƒå½±åŸæ”»ç•¥ï¼‰", link: "#", map: "æ—¥æœ¬ç’°çƒå½±åŸ" },
                    ]
                },
                {
                    date: "12/17 (ä¸‰) Day3",
                    title: "å¤§é˜ªå¸‚å€æ·±åº¦éŠ",
                    items: [
                        { time: "07:30", type: "start", desc: "é£¯åº—å‡ºç™¼ï¼ˆè²·æ—©é¤ï¼‰", highlight: true, map: "VIA INN PRIME å¿ƒé½‹æ©‹å››æ©‹Hotel" },
                        { time: "09:30", type: "visit", desc: "å‹å°¾å¯º (åœç•™ç´„2å°æ™‚)", map: "å‹å°¾å¯º" },
                        { time: "11:30", type: "shopping", desc: "ï¼ƒC-pla æ¢…ç”°èŒ¶å±‹ç”ºåº— (æ‰­è›‹)", map: "ï¼ƒC-pla æ¢…ç”°èŒ¶å±‹ç”ºåº—" },
                        { time: "12:00", type: "meal", desc: "ä¸­å´ç”ºï¼ˆåˆé¤ï¼‰ï¼šneel nakazakicho æˆ– Onigiri Gorichan", map: "ä¸­å´ç”º" },
                        { time: "13:30", type: "visit", desc: "å¤§é˜ªåŸå…¬åœ’ãƒ»å¤©å®ˆé–£ (å…ˆæ›å¾¡åº§èˆ¹ç¥¨)", map: "å¤§é˜ªåŸå…¬åœ’" },
                        { time: "15:00", type: "visit", desc: "å››å¤©ç‹å¯º (æœ‰ç©ºçš„è©±ï¼›é–‹åˆ°å››é»)", map: "å››å¤©ç‹å¯º" },
                        { time: "17:00", type: "visit", desc: "å¤©ç‹å¯ºå…¬åœ’", map: "å¤©ç‹å¯ºå…¬åœ’" },
                        { time: "17:30", type: "shopping", desc: "è¿‘éµç™¾è²¨ é˜¿å€é‡æœ¬åº—", map: "è¿‘éµç™¾è²¨ é˜¿å€é‡æœ¬åº—" },
                        { time: "18:30", type: "visit", desc: "é˜¿å€é‡HARUKASå±•æœ›å°", map: "é˜¿å€é‡HARUKASå±•æœ›å°" },
                        { time: "19:00", type: "meal", desc: "æ™šé¤ï¼ˆè¿‘éµç™¾è²¨å…§æˆ–é™„è¿‘ï¼‰", map: "å¤©ç‹å¯ºè¿‘éµç™¾è²¨å‘¨é‚Šç¾é£Ÿ" },
                        { time: "20:00", type: "visit", desc: "é€šå¤©é–£", map: "é€šå¤©é–£" },
                        { time: "20:30", type: "end", desc: "è¿”å›é£¯åº—", highlight: true },
                    ]
                },
                {
                    date: "12/18 (å››) Day4",
                    title: "äº¬éƒ½æ¸…æ°´å¯ºæ•£ç­–",
                    items: [
                        { time: "ä¸‹åˆ", type: "visit", desc: "æ¸…æ°´å¯º", map: "æ¸…æ°´å¯º" },
                        { time: "ä¸‹åˆ", type: "activity", desc: "äºŒå¹´å‚ã€ä¸‰å¹´å‚ (ç’ƒå…‰å’Œæœé«”é©—)", map: "äºŒå¹´å‚" },
                        { time: "å‚æ™š", type: "visit", desc: "é´¨å·æ•£æ­¥", map: "é´¨å·" },
                    ]
                },
                {
                    date: "12/19 (äº”) Day5",
                    title: "å¤©æ©‹ç«‹&ä¼Šæ ¹èˆŸå±‹&ç¾å±±åˆæŒæ‘ (Klook ä¸€æ—¥è¡Œç¨‹)",
                    items: [
                        { time: "é›†åˆ", type: "meetup", desc: "Klook ä¸€æ—¥è¡Œç¨‹ï¼šèŸ¹é“æ¨‚ é“é “å €æ±åº—é›†åˆ", highlight: true, map: "èŸ¹é“æ¨‚ é“é “å €æ±åº—" },
                        { time: "å…¨å¤©", type: "activity", desc: "å¤©æ©‹ç«‹ã€ä¼Šæ ¹èˆŸå±‹ã€ç¾å±±åˆæŒæ‘ä¸€æ—¥éŠ", map: "å¤©æ©‹ç«‹" },
                    ]
                },
                {
                    date: "12/20 (å…­) Day6",
                    title: "è³¦æ­¸",
                    items: [
                        { time: "08:00", type: "start", desc: "è¾¦ç†é€€æˆ¿", highlight: true },
                        { time: "11:05", type: "departure", desc: "å›ç¨‹èˆªç­ MM031 èµ·é£›", highlight: true, map: "å¤§é˜ªé—œè¥¿é—œè¥¿åœ‹éš›æ©Ÿå ´" },
                    ]
                }
            ],
            
            // ====================================================
            // TRANSPORT GUIDE (ä¿æŒä¸è®Š)
            // ====================================================
            transportGuide: [
                { 
                    title: "é—œè¥¿æ©Ÿå ´ (KIX) å¾€è¿”å¸‚å€", 
                    icon: "fas fa-plane-departure",
                    text: "KIX å¾€è¿”å¤§é˜ªé›£æ³¢/å¿ƒé½‹æ©‹åœ°å€ä¸»è¦æœ‰å…©ç¨®æ–¹å¼ï¼š\n\n**1. å—æµ·é›»éµ Rapi:t:** æœ€å¿«ç´„ 34 åˆ†é˜ç›´é”é›£æ³¢ï¼Œé©åˆä½åœ¨é›£æ³¢æˆ–å¿ƒé½‹æ©‹çš„æ—…å®¢ã€‚\n**2. JR Haruka ç‰¹æ€¥åˆ—è»Š:** é©åˆå‰å¾€å¤©ç‹å¯ºæˆ–æ–°å¤§é˜ªï¼Œè»Šç¨‹ç´„ 35-50 åˆ†é˜ã€‚è‹¥ä½¿ç”¨ ICOCA & Haruka å¥—ç¥¨è¼ƒç‚ºå„ªæƒ ã€‚\n\n**Day 1 æŠµé”äº¤é€šï¼š**\n* é£¯åº—æ­¥è¡Œè‡³å¿ƒé½‹æ©‹ç«™(M19) â†’ é›£æ³¢ç«™(M20) â†’ å—æµ·é›£æ³¢ç«™ â†’ å—æµ·é›»éµç©ºæ¸¯ç·šè‡³é—œè¥¿ç©ºæ¸¯ (NK33)",
                    tip: "å¦‚æœæ‚¨æ˜¯æ­ä¹˜æ¨‚æ¡ƒèˆªç©ºï¼ˆMMï¼‰ï¼Œè«‹è¨˜å¾—æ˜¯åœ¨**ç¬¬äºŒèˆªå»ˆ (T2)**ï¼Œéœ€è¦æ­æ¥é§è»Šåˆ°ç¬¬ä¸€èˆªå»ˆæ‰èƒ½æ­ä¹˜é›»è»Šã€‚"
                },
                { 
                    title: "Day 2ï¼šæ—¥æœ¬ç’°çƒå½±åŸ (USJ) è½‰ä¹˜", 
                    icon: "fas fa-train",
                    text: "å¿ƒé½‹æ©‹ç«™(M19) â†’ æ¢…ç”°ç«™(M16) â†’ å¤§é˜ªç«™(O11) â†’ è¥¿ä¹æ¢ç«™(O14) (è½‰JRæ«»å³¶ç·š) â†’ ç’°çƒå½±åŸç«™(P16)",
                    tip: "å¼·çƒˆå»ºè­°è³¼è²·å¿«é€Ÿé€šé—œï¼Œç‰¹åˆ¥æ˜¯è¶…ç´šä»»å¤©å ‚ä¸–ç•Œã€‚"
                },
                 { 
                    title: "Day 3ï¼šå‹å°¾å¯ºè½‰ä¹˜", 
                    icon: "fas fa-bus",
                    text: "å¿ƒé½‹æ©‹ç«™(M19) â†’ ç®•é¢è±é‡ç«™(M06) â†’ 6è™Ÿæœˆå°è½‰ä¹˜ 29/30è™Ÿå…¬è»Šç›´é”å‹å°¾å¯º",
                    tip: "ç”±æ–¼å…¬è»Šç­æ¬¡è¼ƒå°‘ï¼Œè«‹å‹™å¿…å…ˆç¢ºèªå¥½å›ç¨‹æ™‚é–“ã€‚"
                },
                { 
                    title: "Day 4ï¼šå¤§é˜ªè‡³äº¬éƒ½äº¤é€š", 
                    icon: "fas fa-route",
                    text: "**å¤§é˜ªè‡³äº¬éƒ½ï¼š** å¿ƒé½‹æ©‹ç«™(M19) â†’ æ¢…ç”°ç«™(M16) â†’ JRå¤§é˜ªç«™ â†’ JRäº¬éƒ½ç«™\n\n**äº¬éƒ½ç•¶åœ°äº¤é€šï¼š**\n1. æ­ Uber è‡³æ¸…æ°´å‚èˆ‡äº”æ¢é€šå£ (ç´„500å…ƒå°å¹£)\n2. æ­ 206 è™Ÿå·´å£«åœ¨æ¸…æ°´é“ç«™ä¸‹è»Š\n3. è½‰åœ°ä¸‹éµçƒä¸¸ç·šè‡³ä¹æ¢ç«™(1è™Ÿå‡ºå£)æ­ 202/207 è™Ÿå·´å£«åœ¨æ¸…æ°´é“ç«™ä¸‹è»Š",
                    tip: "äº¬éƒ½çš„å…¬è»Šè·¯ç·šè¤‡é›œä¸”æ“æ“ ï¼Œå»ºè­°æ­é…åœ°ä¸‹éµæˆ–è¨ˆç¨‹è»Š/Uberï¼Œä»¥ç¯€çœæ™‚é–“ã€‚"
                },
                { 
                    title: "Day 5ï¼šå¤©æ©‹ç«‹è¡Œç¨‹é›†åˆè½‰ä¹˜", 
                    icon: "fas fa-street-view",
                    text: "å››æ©‹ç«™(Y14) â†’ é›£æ³¢ç«™(Y15) â†’ è½‰åƒæ—¥å‰ç·šè‡³æ—¥æœ¬æ©‹ç«™(S17) æ­¥è¡Œè‡³èŸ¹é“æ¨‚ é“é “å €æ±åº—é›†åˆ",
                    tip: "ç”±æ–¼æ˜¯ Klook ä¸€æ—¥è¡Œç¨‹ï¼Œè«‹å‹™å¿…æº–æ™‚åˆ°é”é›†åˆåœ°é»ï¼Œä»¥å…è€½èª¤è¡Œç¨‹ã€‚"
                },
                { 
                    title: "Day 6ï¼šè³¦æ­¸äº¤é€š", 
                    icon: "fas fa-plane",
                    text: "é£¯åº—æ­¥è¡Œè‡³å¿ƒé½‹æ©‹ç«™(M19) â†’ é›£æ³¢ç«™(M20) â†’ å—æµ·é›£æ³¢ç«™ â†’ å—æµ·é›»éµç©ºæ¸¯ç·šè‡³é—œè¥¿ç©ºæ¸¯ (NK33)",
                    tip: "å—æµ·é›»éµ Rapi:t å…¨è»Šç‚ºå°è™Ÿåº§ï¼Œå¯äº‹å…ˆåœ¨é›£æ³¢ç«™è³¼è²·æˆ–ç¶²è·¯é è¨‚ï¼Œç¢ºä¿æœ‰ä½ã€‚"
                },
                { 
                    title: "å¤§é˜ªå¸‚å…§äº¤é€šï¼šåœ°éµèˆ‡ JR", 
                    icon: "fas fa-subway",
                    text: "å¤§é˜ªåœ°éµå…±æœ‰ 8 æ¢è·¯ç·šï¼Œè¦†è“‹å¤§éƒ¨åˆ†å¸‚å€æ™¯é»ã€‚ä¸»è¦æ™¯é»å¦‚å¿ƒé½‹æ©‹ã€é›£æ³¢ã€æ¢…ç”°éƒ½åœ¨å¾¡å ‚ç­‹ç·šä¸Š (M)ã€‚\n\n**å»ºè­°ç¥¨åˆ¸ï¼š**\n* **ICOCA å¡ (é¡ä¼¼æ‚ éŠå¡):** é©ç”¨æ–¼åœ°éµã€JRã€ç§éµã€å·´å£«ã€å„²å€¼å³å¯ä½¿ç”¨ï¼Œæ–¹ä¾¿å¿«é€Ÿã€‚\n* **å¤§é˜ªå‘¨éŠå¡/ä¸€æ—¥åˆ¸:** è‹¥ç•¶å¤©è¡Œç¨‹åŒ…å«å¤šå€‹ä»˜è²»æ™¯é»ä¸”å¤§é‡æ­ä¹˜åœ°éµï¼Œå¯è€ƒæ…®è³¼è²·ã€‚",
                    tip: "åœ¨é›£æ³¢ç«™ï¼ŒJRã€å—æµ·é›»éµã€è¿‘éµã€åœ°éµéƒ½åŒ¯é›†æ–¼æ­¤ï¼Œè½‰ä¹˜è·¯ç·šè¼ƒè¤‡é›œï¼Œè«‹é ç•™å……è¶³æ™‚é–“ä¸¦æ³¨æ„æŒ‡æ¨™ã€‚"
                },
            ],
            
            // ====================================================
            // FOOD RECOMMENDATIONS (ç¾é£Ÿæ¸…å–®)
            // ====================================================
            foodRecommendations: [
                { city: "å¤§é˜ª", area: "ä¸­å´ç”º", items: [
                    "neel nakazakicho (å’–å•¡å»³)",
                    "Onigiri Gorichan (ä¸‰è§’é£¯ç³°)"
                ]},
                { city: "å¤§é˜ª", area: "å¤§é˜ªåŸ", items: [
                    "R Bakerï¼ˆéºµåŒ…åº—ï¼‰",
                    "OSA coffee"
                ]},
                { city: "å¤§é˜ª", area: "æ¢…ç”°", items: [
                    "ãƒ¢ãƒªã‚¿å±‹ å£½å–œç‡’"
                ]},
                { city: "å¤§é˜ª", area: "é»‘é–€å¸‚å ´", items: [
                    "é˜¿å©†é°»é­šé£¯"
                ]},
                { city: "å¤§é˜ª", area: "é›£æ³¢", items: [
                    "å‘³ä¹ƒå®¶ å¤§é˜ªç‡’"
                ]},
                { city: "å¤§é˜ª", area: "å¿ƒé½‹æ©‹", items: [
                    "ã†ãªãã®ä¸­åº„ï¼ˆé°»é­šé£¯ï¼‰"
                ]},
                { city: "å¤§é˜ª", area: "é˜¿å€é‡", items: [
                    "é³—é±¼çš„æˆæ¿‘"
                ]},
                { city: "äº¬éƒ½", area: "é€šç”¨/ç¥‡åœ’/äºŒå¹´å‚", items: [
                    "äºŒå¹´å‚é™„è¿‘é°»é­šé£¯",
                    "ç¥‡åœ’ é°» å·è—¤ï¼ˆé°»é­šé£¯ï¼‰",
                    "å…«å‚ç¥ç¤¾é™„è¿‘é´¨è‚‰é£¯",
                    "å…«å‚ç¥ç¤¾é™„è¿‘ç‚¸ç‰›æ’",
                    "GOKAGO æ—¥æœ¬èŒ¶å°‚é–€åº—"
                ]}
            ]
        };


        // ====================================================================
        // II. LOCALSTORAGE UTILS (ç•¥)
        // ====================================================================

        /**
         * å¾ LocalStorage è¼‰å…¥è³‡æ–™
         * @param {string} key
         * @param {*} defaultValue
         * @returns
         */
        function loadFromLS(key, defaultValue) {
            const data = localStorage.getItem(LS_PREFIX + key + '_' + userId);
            if (data === null) return defaultValue;
            try {
                return JSON.parse(data);
            } catch (e) {
                console.error("Error parsing LS data for key:", key, e);
                // å¦‚æœè§£æå¤±æ•—ï¼Œè¿”å›é è¨­å€¼ä¸¦æ¸…é™¤èˆŠçš„å£è³‡æ–™
                localStorage.removeItem(LS_PREFIX + key + '_' + userId);
                return defaultValue;
            }
        }

        /**
         * å„²å­˜è³‡æ–™åˆ° LocalStorage
         * @param {string} key
         * @param {*} value
         */
        function saveToLS(key, value) {
            try {
                localStorage.setItem(LS_PREFIX + key + '_' + userId, JSON.stringify(value));
            } catch (e) {
                console.error("Error saving to LS for key:", key, e);
                // å¦‚æœ LocalStorage æ»¿äº†ï¼Œå¯ä»¥åœ¨é€™è£¡çµ¦ç”¨æˆ¶æç¤º
            }
        }

        // åˆå§‹åŒ–/è¼‰å…¥æŒä¹…åŒ–ç‹€æ…‹ (å„ªå…ˆå¾ LocalStorage è¼‰å…¥)
        let exchangeRate = loadFromLS('exchangeRate', DEFAULT_EXCHANGE_RATE);
        let budgetEntries = loadFromLS('budgetEntries', []);
        
        // æ ¸å¿ƒï¼šæ–°å¢è³¼ç‰©æ¸…å–®åˆ†é¡åˆ°é è¨­æ¸…å–®
        let checklistItems = loadFromLS('checklistItems', initialTripInfo.checklist || [
            { id: 1, text: "è­·ç…§ã€èº«ä»½è­‰ã€é›»å­ç°½è­‰/å…¥å¢ƒå¡", checked: false, category: 'è­‰ä»¶' },
            { id: 2, text: "æ—¥åœ“ç¾é‡‘ã€ä¿¡ç”¨å¡", checked: false, category: 'è­‰ä»¶' },
            { id: 3, text: "ç¶²å¡/Wi-Fiæ©Ÿ/eSIM", checked: false, category: 'é€šè¨Š' },
            { id: 4, text: "æ‰‹æ©Ÿã€å……é›»ç·šã€è¡Œå‹•é›»æº", checked: false, category: 'é›»å­ç”¢å“' },
            { id: 5, text: "è½‰æ›æ’é ­/å»¶é•·ç·š", checked: false, category: 'é›»å­ç”¢å“' },
            { id: 6, text: "å€‹äººè—¥å“ã€OKç¹ƒã€å£ç½©", checked: false, category: 'è—¥å“' },
            { id: 7, text: "ç›¥æ´—ç”¨å“ã€åŒ–å¦å“", checked: false, category: 'ç›¥æ´—' },
            { id: 8, text: "è¶³å¤ è¡£ç‰©ã€ç™¼ç†±è¡£ (ä¾å¤©æ°£èª¿æ•´)", checked: false, category: 'è¡£ç‰©' },
            { id: 9, text: "é›¨å‚˜/é›¨è¡£ (å‚™ç”¨)", checked: false, category: 'é›œç‰©' },
            { id: 10, text: "æ—…éŠç¥¨åˆ¸ã€è¡Œç¨‹ç¢ºèªå–®", checked: false, category: 'é›œç‰©' },
            // ** è³¼ç‰©æ¸…å–®é …ç›® **
            { id: 11, text: "æ—¥æœ¬è—¥å¦æ¸…å–®", checked: false, category: 'è³¼ç‰©æ¸…å–®' }, 
            { id: 12, text: "é›¶é£Ÿä¼´æ‰‹ç¦®æ¸…å–®", checked: false, category: 'è³¼ç‰©æ¸…å–®' }, 
            { id: 13, text: "é›»å™¨ç”¢å“ (å¹é¢¨æ©Ÿã€ä¿æº«æ¯ç­‰)", checked: false, category: 'è³¼ç‰©æ¸…å–®' },
        ]);

        // ç¢ºä¿ memoContent è¢«æ­£ç¢ºè¼‰å…¥æˆ–åˆå§‹åŒ–
        let memoContent = loadFromLS('memoContent', ''); 

        // æ ¸å¿ƒè¡Œç¨‹è³‡è¨Š (å¯ç·¨è¼¯)
        let tripInfo = loadFromLS('tripInfo', initialTripInfo);
        
        // ç¢ºä¿æ–°åŠ å…¥çš„ foodRecommendations å’Œ transportGuide å­˜åœ¨ï¼Œè‹¥æ²’æœ‰å‰‡å¾ initialTripInfo è£œä¸Š
        if (!tripInfo.transportGuide) {
            tripInfo.transportGuide = initialTripInfo.transportGuide;
            saveToLS('tripInfo', tripInfo);
        }
        if (!tripInfo.foodRecommendations) {
            tripInfo.foodRecommendations = initialTripInfo.foodRecommendations;
            saveToLS('tripInfo', tripInfo);
        }


        // ====================================================================
        // III. COMMON UTILS (ç•¥)
        // ====================================================================

        function formatCurrency(amount, currencyCode) {
            const options = {
                style: 'currency',
                currency: currencyCode,
                minimumFractionDigits: 0
            };
            return new Intl.NumberFormat('zh-TW', options).format(amount);
        }

        /**
         * Base64 è½‰ ArrayBuffer (ç”¨æ–¼åœ–ç‰‡å£“ç¸®)
         * @param {string} base64
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64.split(',')[1] || base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * åœ–ç‰‡å£“ç¸®ä¸¦è½‰ Base64
         * @param {string} dataUrl - åŸå§‹ Base64 åœ–ç‰‡
         * @returns {Promise<string>} - å£“ç¸®å¾Œçš„ Base64 åœ–ç‰‡
         */
        function compressImage(dataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 200; // ç¸®åœ–æœ€å¤§å¯¬åº¦
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height = height * (MAX_WIDTH / width);
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // è½‰ç‚º JPEG æ ¼å¼ï¼Œå“è³ª 0.7ï¼Œæ¸›å°‘å­—ä¸²é•·åº¦
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    resolve(compressedDataUrl);
                };
                img.onerror = () => resolve(''); // è™•ç†è¼‰å…¥éŒ¯èª¤
                img.src = dataUrl;
            });
        }


        // ====================================================================
        // IV. VIEW RENDERING (é é¢æ¸²æŸ“)
        // ====================================================================

        function renderPage() {
            const contentDiv = document.getElementById('content');
            let html = '';
            
            // æ›´æ–°å°èˆªåˆ—ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === currentPage) {
                    btn.classList.add('active');
                }
            });
            
            switch (currentPage) {
                case 'plan':
                    html = renderPlanPage();
                    break;
                case 'guide':
                    html = renderTransportPage(); 
                    break;
                case 'wallet':
                    html = renderWalletPage();
                    break;
                case 'lists':
                    html = renderListsPage();
                    break;
                case 'info':
                    html = renderInfoPage();
                    break;
            }
            contentDiv.innerHTML = html;
            
            // é é¢ç‰¹å®šäº‹ä»¶ç›£è½ (éœ€è¦åœ¨ innerHTML ä¹‹å¾Œç¶å®š)
            if (currentPage === 'wallet') {
                bindWalletEvents();
                document.getElementById('exchange-rate-input').value = exchangeRate;
            } else if (currentPage === 'lists') {
                bindListsEvents();
            } else if (currentPage === 'info') {
                bindInfoEvents();
            }
        }

        // ====================================================================
        // PLAN é é¢ (ä¿æŒä¸è®Š)
        // ====================================================================

        function getIconForType(type) {
            switch(type) {
                case 'arrival': return 'plane-arrival';
                case 'departure': return 'plane-departure';
                case 'transfer': return 'train';
                case 'visit': return 'location-dot';
                case 'meal': return 'utensils';
                case 'activity': return 'ticket';
                case 'shopping': return 'bag-shopping';
                case 'meetup': return 'handshake-angle';
                case 'start': case 'end': return 'flag';
                case 'tip': return 'lightbulb';
                default: return 'circle-info';
            }
        }

        /**
         * æ¸²æŸ“è¡Œç¨‹å–®ä¸€ç´°é …çš„ HTML
         * @param {object} item - è¡Œç¨‹ç´°é …è³‡æ–™
         * @param {number} dayIndex - è©²ç´°é …æ‰€å±¬æ—¥çš„ç´¢å¼•
         * @param {number} itemIndex - è©²ç´°é …åœ¨æ—¥ä¸­çš„ç´¢å¼•
         * @returns {string} HTML å­—ä¸²
         */
        function getTimelineItemHtml(item, dayIndex, itemIndex) {
            // ç”±æ–¼ map=... ç¶²å€å¤ªé•·ï¼Œé€™è£¡ä½¿ç”¨ä¸€å€‹è¼ƒçŸ­çš„ Google Maps æœå°‹é€£çµ
            const mapLink = item.map ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent('æ—¥æœ¬å¤§é˜ª ' + item.map)}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 font-medium ml-2 inline-flex items-center"><i class="fas fa-map-pin mr-1"></i> åœ°åœ–</a>` : '';
            const linkBtn = item.link && item.link !== '#' ? `<a href="${item.link}" target="_blank" class="text-xs text-teal-600 hover:text-teal-800 font-medium ml-2 inline-flex items-center"><i class="fas fa-link mr-1"></i> é€£çµ</a>` : '';
            
            let timeDisplay = item.time;
            if (item.highlight) {
                timeDisplay = `<span class="highlight-time">${item.time}</span>`;
            }

            return `
                <div class="relative pl-6 pb-8 timeline-item" id="item-${dayIndex}-${itemIndex}">
                    <div class="timeline-dot"></div>
                    <div class="muji-card p-4 ml-2">
                        <div class="flex justify-between items-start">
                            <p class="text-sm font-semibold text-gray-700 mb-1">${timeDisplay}</p>
                            <button onclick="openEditItemModal(${dayIndex}, ${itemIndex})" class="text-gray-400 hover:text-var(--color-primary) p-1 -mt-1 -mr-1">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                        </div>

                        <div class="flex items-start">
                            <i class="fas fa-${getIconForType(item.type)} text-gray-500 mr-2 mt-1 text-sm"></i>
                            <p class="text-base text-gray-800 leading-relaxed">${item.desc}</p>
                        </div>
                        <div class="flex flex-wrap mt-2 -ml-2">
                            ${mapLink} ${linkBtn}
                        </div>
                    </div>
                </div>
            `;
        }


        function renderPlanPage() {
            let flightHtml = tripInfo.flight.map(f => `
                <div class="muji-card p-4 mb-3 text-sm">
                    <p class="font-bold text-gray-800">${f.type}ï¼š${f.date}</p>
                    <p class="text-gray-700 mt-1">
                        <i class="fas fa-plane-departure text-gray-500 mr-2"></i>
                        ${f.dep} (${f.from})
                        <span class="text-gray-400 mx-2">â¡ï¸</span>
                        ${f.arr} (${f.to})
                    </p>
                    <p class="text-gray-600 mt-1"><i class="fas fa-ticket-alt text-gray-500 mr-2"></i>èˆªç­ç·¨è™Ÿ: ${f.flightNo}</p>
                </div>
            `).join('');

            let itineraryHtml = tripInfo.days.map((day, dayIndex) => `
                <div class="muji-card p-5 mb-6" id="day-${dayIndex}">
                    <div class="flex justify-between items-center border-b pb-2 mb-4 border-gray-100">
                        <h3 class="text-xl font-bold text-gray-800">
                            ${day.date} / ${day.title}
                        </h3>
                        <button onclick="openEditDayModal(${dayIndex})" class="text-gray-400 hover:text-var(--color-primary) p-1">
                            <i class="fas fa-pencil-alt text-sm"></i> ç·¨è¼¯
                        </button>
                    </div>
                    <div class="relative pl-4">
                        ${day.items.map((item, itemIndex) => getTimelineItemHtml(item, dayIndex, itemIndex)).join('')}
                    </div>
                    <button onclick="openAddItemModal(${dayIndex})" 
                        class="muji-btn mt-4 w-full py-2 bg-var(--color-accent)/20 hover:bg-var(--color-primary) text-var(--color-primary) hover:text-white border border-var(--color-accent) text-sm font-semibold transition-colors">
                        <i class="fas fa-plus mr-1"></i> æ–°å¢è¡Œç¨‹é …ç›®
                    </button>
                </div>
            `).join('');


            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ—“ï¸ è¡Œç¨‹è¡¨ (PLAN)</h2>
                
                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 border-b border-gray-100 pb-1">æ ¸å¿ƒè³‡è¨Š</h3>
                    <p class="text-base text-gray-700 mb-2">
                        <i class="fas fa-hotel text-var(--color-primary) mr-2"></i>
                        <span class="font-medium">ä½å®¿:</span> ${tripInfo.hotel}
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(tripInfo.hotel)}" target="_blank" class="text-xs text-blue-600 ml-2">(åœ°åœ–)</a>
                    </p>
                    <div class="space-y-3">
                        ${flightHtml}
                    </div>
                </div>

                <h3 class="text-xl font-bold text-gray-800 mb-4 mt-6">è©³ç´°æ¯æ—¥è¦åŠƒ</h3>
                ${itineraryHtml}
            `;
        }

        // ====================================================================
        // è¡Œç¨‹ç·¨è¼¯/æ–°å¢ Modal é‚è¼¯ (Item CRUD - ä¿æŒä¸è®Š)
        // ====================================================================

        /**
         * é–‹å•Ÿè¡Œç¨‹ç´°é …ç·¨è¼¯ Modal
         * @param {number} dayIndex
         * @param {number} itemIndex
         */
        window.openEditItemModal = function(dayIndex, itemIndex) {
            const item = tripInfo.days[dayIndex].items[itemIndex];
            
            // è¨­å®š Modal æ¨¡å¼å’Œæ¨™é¡Œ
            document.getElementById('modal-mode').value = 'edit';
            document.getElementById('modal-title').textContent = 'ç·¨è¼¯è¡Œç¨‹ç´°é …';
            
            // é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            document.getElementById('delete-btn').style.display = 'block';

            // è¼‰å…¥è³‡æ–™
            document.getElementById('modal-day-index').value = dayIndex;
            document.getElementById('modal-item-index').value = itemIndex;
            document.getElementById('modal-time').value = item.time || '';
            document.getElementById('modal-desc').value = item.desc.replace(/<br>/g, '\n') || ''; // æ›¿æ› <br> ç‚ºæ›è¡Œ
            document.getElementById('modal-type').value = item.type || '';
            document.getElementById('modal-map').value = item.map || '';
            document.getElementById('modal-highlight').checked = item.highlight || false;
            
            document.getElementById('edit-item-modal').style.display = 'block';
        }

        /**
         * é–‹å•Ÿæ–°å¢è¡Œç¨‹ç´°é … Modal
         * @param {number} dayIndex
         */
        window.openAddItemModal = function(dayIndex) {
            // è¨­å®š Modal æ¨¡å¼å’Œæ¨™é¡Œ
            document.getElementById('modal-mode').value = 'add';
            document.getElementById('modal-title').textContent = `ç‚º Day ${dayIndex + 1} æ–°å¢é …ç›®`;
            
            // éš±è—åˆªé™¤æŒ‰éˆ•
            document.getElementById('delete-btn').style.display = 'none';

            // æ¸…ç©ºä¸¦è¨­å®š Day Index
            document.getElementById('modal-day-index').value = dayIndex;
            document.getElementById('modal-item-index').value = -1; // -1 è¡¨ç¤ºæ–°å¢
            document.getElementById('modal-time').value = '';
            document.getElementById('modal-desc').value = ''; 
            document.getElementById('modal-type').value = 'visit'; // é è¨­é¡å‹
            document.getElementById('modal-map').value = '';
            document.getElementById('modal-highlight').checked = false;
            
            document.getElementById('edit-item-modal').style.display = 'block';
        }

        window.closeEditItemModal = function() {
            document.getElementById('edit-item-modal').style.display = 'none';
        }

        window.saveEditedItem = function() {
            const dayIndex = parseInt(document.getElementById('modal-day-index').value);
            const itemIndex = parseInt(document.getElementById('modal-item-index').value);
            const mode = document.getElementById('modal-mode').value;
            
            const newTime = document.getElementById('modal-time').value.trim();
            const newDesc = document.getElementById('modal-desc').value.trim().replace(/\n/g, '<br>'); // å°‡æ›è¡Œè½‰å› <br>
            const newType = document.getElementById('modal-type').value.trim() || 'visit';
            const newMap = document.getElementById('modal-map').value.trim();
            const newHighlight = document.getElementById('modal-highlight').checked;
            
            if (!newTime || !newDesc || isNaN(dayIndex)) {
                alert("æ™‚é–“ã€å…§å®¹å’Œæ—¥æœŸä¸èƒ½ç‚ºç©ºï¼");
                return;
            }

            const newItemData = {
                time: newTime,
                type: newType,
                desc: newDesc,
                map: newMap,
                highlight: newHighlight
            };

            if (mode === 'edit' && !isNaN(itemIndex) && itemIndex >= 0) {
                // ** ç·¨è¼¯æ¨¡å¼ **
                Object.assign(tripInfo.days[dayIndex].items[itemIndex], newItemData);
                
            } else if (mode === 'add') {
                // ** æ–°å¢æ¨¡å¼ **
                tripInfo.days[dayIndex].items.push(newItemData);
                
            } else {
                alert("å„²å­˜å¤±æ•—ï¼šç„¡æ•ˆçš„æ“ä½œæ¨¡å¼æˆ–ç´¢å¼•ã€‚");
                return;
            }

            // å„²å­˜ä¸¦é‡æ–°æ¸²æŸ“
            saveToLS('tripInfo', tripInfo);
            closeEditItemModal();
            renderPage();
        }

        /**
         * åˆªé™¤ç•¶å‰ Modal ä¸­çš„è¡Œç¨‹é …ç›®
         */
        window.deleteItem = function() {
            const dayIndex = parseInt(document.getElementById('modal-day-index').value);
            const itemIndex = parseInt(document.getElementById('modal-item-index').value);

            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¡Œç¨‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) {
                if (!isNaN(dayIndex) && !isNaN(itemIndex) && itemIndex >= 0) {
                    tripInfo.days[dayIndex].items.splice(itemIndex, 1);
                    saveToLS('tripInfo', tripInfo);
                    closeEditItemModal();
                    renderPage();
                } else {
                    alert("åˆªé™¤å¤±æ•—ï¼šç„¡æ³•è­˜åˆ¥é …ç›®ã€‚");
                }
            }
        }
        
        // ====================================================================
        // è¡Œç¨‹æ—¥æ¨™é¡Œç·¨è¼¯ Modal é‚è¼¯ (Day Title CRUD - ä¿æŒä¸è®Š)
        // ====================================================================

        /**
         * é–‹å•Ÿè¡Œç¨‹æ—¥æ¨™é¡Œç·¨è¼¯ Modal
         * @param {number} dayIndex
         */
        window.openEditDayModal = function(dayIndex) {
            const day = tripInfo.days[dayIndex];
            
            // è¼‰å…¥è³‡æ–™
            document.getElementById('day-modal-index').value = dayIndex;
            document.getElementById('day-modal-date').value = day.date || '';
            document.getElementById('day-modal-title').value = day.title || '';
            
            document.getElementById('edit-day-modal').style.display = 'block';
        }

        window.closeEditDayModal = function() {
            document.getElementById('edit-day-modal').style.display = 'none';
        }

        window.saveEditedDay = function() {
            const dayIndex = parseInt(document.getElementById('day-modal-index').value);
            
            const newDate = document.getElementById('day-modal-date').value.trim();
            const newTitle = document.getElementById('day-modal-title').value.trim();
            
            if (!newDate || !newTitle || isNaN(dayIndex)) {
                alert("æ—¥æœŸæè¿°å’Œè¡Œç¨‹æ¨™é¡Œä¸èƒ½ç‚ºç©ºï¼");
                return;
            }

            // æ›´æ–°æ•¸æ“š
            tripInfo.days[dayIndex].date = newDate;
            tripInfo.days[dayIndex].title = newTitle;

            // å„²å­˜ä¸¦é‡æ–°æ¸²æŸ“
            saveToLS('tripInfo', tripInfo);
            closeEditDayModal();
            renderPage();
        }

        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const itemModal = document.getElementById('edit-item-modal');
            const dayModal = document.getElementById('edit-day-modal');
            const resetModal = document.getElementById('reset-confirm-modal');

            if (event.target == itemModal) {
                closeEditItemModal();
            } else if (event.target == dayModal) {
                closeEditDayModal();
            } else if (event.target == resetModal) {
                closeResetConfirmModal();
            }
        }


        // ====================================================================
        // GUIDE é é¢ (å¤©æ°£/äº¤é€š) (ç•¥)
        // ====================================================================

        function renderTransportPage() {
            const guideContent = tripInfo.transportGuide;

            // **æ¨¡æ“¬**å³æ™‚å¤©æ°£è³‡æ–™ (æ­¤è™•ä¿æŒä¸è®Š)
            const currentWeather = {
                location: "å¤§é˜ªå¸‚",
                date: "12æœˆ15æ—¥",
                temperature: "8Â°C ~ 14Â°C",
                condition: "å¤šé›²æ™‚æ™´",
                icon: "fas fa-cloud-sun"
            };

            const weatherHtml = `
                <div class="muji-card p-5 mb-6 bg-var(--color-accent)/20 border-var(--color-accent)">
                    <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-umbrella mr-3 text-2xl text-var(--color-primary)"></i> ${currentWeather.location} å³æ™‚å¤©æ°£
                    </h3>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-4xl font-light text-gray-900">${currentWeather.temperature}</p>
                            <p class="text-sm text-gray-600">${currentWeather.date} / ${currentWeather.condition}</p>
                        </div>
                        <i class="${currentWeather.icon} text-6xl text-amber-500"></i>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 border-t pt-2">
                        *æ­¤ç‚ºæ¨¡æ“¬æ•¸æ“šï¼Œå¯¦éš›ä½¿ç”¨è«‹æŸ¥è©¢å°ˆæ¥­å¤©æ°£ Appã€‚
                    </p>
                </div>
            `;

            // --- è¡Œç¨‹äº¤é€šæ‘˜è¦å€å¡Š (æ‡‰ç‚ºç©º) ---
            const extractedTransport = [];
            const transportSummaryHtml = `
                <h3 class="text-xl font-bold text-gray-800 mb-4 mt-6">ğŸ“ è¡Œç¨‹äº¤é€šæ‘˜è¦ (æ‚¨çš„æ’ç¨‹)</h3>
                ${extractedTransport.length > 0 ? extractedTransport : '<p class="p-4 text-center text-gray-500">è¡Œç¨‹ä¸­æ²’æœ‰æ˜ç¢ºæ¨™è¨»çš„äº¤é€šè½‰ä¹˜æˆ–å»ºè­°ã€‚</p>'}
            `;
            // ------------------------------------

            const guideHtml = guideContent.map(item => `
                <div class="muji-card p-5 mb-5">
                    <h3 class="text-xl font-bold text-var(--color-primary) mb-3 flex items-center">
                        <i class="${item.icon} mr-3 text-2xl"></i>${item.title}
                    </h3>
                    <p class="text-gray-700 whitespace-pre-wrap leading-relaxed text-justify">${item.text}</p>
                    ${item.tip ? `<blockquote class="mt-3 p-3 text-sm italic border-l-4 border-var(--color-accent) bg-gray-50">è²¼å¿ƒæé†’: ${item.tip}</blockquote>` : ''}
                </div>
            `).join('');

            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸŒ¤ï¸ å¤©æ°£èˆ‡äº¤é€š (WEATHER & TRANSPORT)</h2>
                
                ${weatherHtml}

                ${transportSummaryHtml}
                
                <h3 class="text-xl font-bold text-gray-800 mb-4 mt-6">ğŸš„ æ ¸å¿ƒäº¤é€šæŒ‡å— (é€šç”¨è³‡è¨Š)</h3>
                ${guideHtml}
                
                <h3 class="text-xl font-bold text-gray-800 mb-4 mt-8">ğŸ—ºï¸ å¤§é˜ªäº¤é€šåœ°åœ–æ¦‚è¦½</h3>
                <div class="muji-card p-2 h-80 overflow-hidden">
                    <iframe 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        scrolling="no" 
                        marginheight="0" 
                        marginwidth="0" 
                        src="https://www.openstreetmap.org/export/embed.html?bbox=135.485%2C34.675%2C135.535%2C34.705&layer=mapnik&marker=34.69%2C135.51" 
                        style="border: 1px solid black; border-radius: 8px;"
                    ></iframe>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">åœ°åœ–ä¸­å¿ƒç´„ç‚ºå¤§é˜ªé›£æ³¢/å¿ƒé½‹æ©‹å€åŸŸ</p>
            `;
        }
        
        // ====================================================================
        // æ–°å¢çš„é€šç”¨å‡½æ•¸ï¼šåˆ‡æ›é é¢ä¸¦æ»¾å‹•åˆ°æŒ‡å®šå…ƒç´ 
        // ====================================================================
        window.changePageAndScroll = function(page, elementId) {
            currentPage = page;
            renderPage();
            
            // ä½¿ç”¨ setTimeout ç¢ºä¿ DOM æ¸²æŸ“å®Œæˆå¾Œå†æ»¾å‹•
            setTimeout(() => {
                const targetElement = document.getElementById(elementId);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50); 
        }

        // ====================================================================
        // WALLET é é¢ (ç•¥)
        // ====================================================================

        function calculateTWD(jpy) {
            return Math.round(jpy * exchangeRate);
        }

        function addBudgetEntry() {
            const item = document.getElementById('item-input').value.trim();
            const jpyExpression = document.getElementById('jpy-input').value.trim();
            const fileInput = document.getElementById('receipt-image');
            
            if (!item || !jpyExpression) {
                alert("è«‹è¼¸å…¥é …ç›®åç¨±å’Œæ—¥å¹£é‡‘é¡/ç®—å¼ï¼");
                return;
            }

            // å˜—è©¦è¨ˆç®— JPY é‡‘é¡
            let jpy = 0;
            try {
                // ä½¿ç”¨ Function æ§‹é€ å‡½æ•¸ä¾†å®‰å…¨åŸ·è¡Œç®—å¼ï¼Œé¿å…ä½¿ç”¨ eval
                jpy = new Function('return ' + jpyExpression)();
                if (typeof jpy !== 'number' || isNaN(jpy)) {
                    throw new Error("Invalid calculation result");
                }
                jpy = Math.round(jpy);
            } catch (e) {
                alert("æ—¥å¹£ç®—å¼ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥è¼¸å…¥ï¼");
                return;
            }

            const twd = calculateTWD(jpy);

            const entry = {
                item: item,
                jpy: jpy,
                twd: twd,
                image: null // åœ–ç‰‡ Base64 å­—ä¸²
            };

            // è™•ç†åœ–ç‰‡ä¸Šå‚³
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = async (e) => {
                    // å£“ç¸®åœ–ç‰‡
                    entry.image = await compressImage(e.target.result);
                    
                    budgetEntries.unshift(entry);
                    saveToLS('budgetEntries', budgetEntries);
                    renderPage();
                };
                reader.readAsDataURL(file);
            } else {
                budgetEntries.unshift(entry);
                saveToLS('budgetEntries', budgetEntries);
                renderPage();
            }
        }

        window.updateExchangeRate = function(newRate) {
            const input = document.getElementById('exchange-rate-input');
            let rate = parseFloat(newRate || input.value);
            
            if (isNaN(rate) || rate <= 0) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åŒ¯ç‡ï¼");
                input.value = exchangeRate; // é‚„åŸèˆŠå€¼
                return;
            }

            exchangeRate = rate;
            saveToLS('exchangeRate', exchangeRate);
            
            // é‡æ–°è¨ˆç®—æ‰€æœ‰ TWD ç¸½é¡
            budgetEntries.forEach(entry => {
                entry.twd = calculateTWD(entry.jpy);
            });

            saveToLS('budgetEntries', budgetEntries);
            renderPage();
        }

        window.deleteBudgetEntry = function(index) {
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³å—ï¼Ÿ")) {
                budgetEntries.splice(index, 1);
                saveToLS('budgetEntries', budgetEntries);
                renderPage();
            }
        }

        function bindWalletEvents() {
            // ç¶å®šè¨ˆç®—æŒ‰éˆ•
            document.getElementById('calculate-btn').onclick = addBudgetEntry;
        }

        function renderWalletPage() {
            let entriesHtml = budgetEntries.map((entry, index) => `
                <div class="flex items-center p-3 border-b border-gray-100 last:border-b-0">
                    <div class="w-12 h-12 flex-shrink-0 mr-3 overflow-hidden rounded-md bg-gray-100">
                        ${entry.image ? `<img src="${entry.image}" alt="æ”¶æ“š" class="w-full h-full object-cover">` : `<i class="fas fa-camera text-gray-400 text-lg flex items-center justify-center w-full h-full"></i>`}
                    </div>
                    <div class="flex-grow min-w-0">
                        <p class="font-medium text-gray-800 truncate">${entry.item}</p>
                        <p class="text-sm text-gray-600">
                            <span class="font-semibold text-red-600">${formatCurrency(entry.jpy, 'JPY')}</span>
                            <span class="text-gray-400 mx-1">/</span>
                            ${formatCurrency(entry.twd, 'TWD')}
                        </p>
                    </div>
                    <button onclick="deleteBudgetEntry(${index})" class="text-red-400 hover:text-red-600 text-lg p-1 ml-2">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('');

            const totalJPY = budgetEntries.reduce((sum, entry) => sum + entry.jpy, 0);
            const totalTWD = budgetEntries.reduce((sum, entry) => sum + entry.twd, 0);

            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ’° è¨˜å¸³èˆ‡åŒ¯ç‡ (WALLET)</h2>

                <div class="muji-card p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1">å³æ™‚åŒ¯ç‡æ›ç®— (1 JPY = <span id="current-rate">${exchangeRate}</span> TWD)</h3>
                    
                    <label for="exchange-rate-input" class="block text-sm font-medium text-gray-700 mb-2">è¨­å®šåŒ¯ç‡ (1 JPY = ? TWD)</label>
                    <div class="flex mb-4">
                        <input type="number" id="exchange-rate-input" step="0.001" min="0.1"
                            class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-var(--color-primary) focus:border-var(--color-primary) text-lg"
                            onchange="updateExchangeRate(this.value)">
                        <button onclick="updateExchangeRate()" class="muji-btn px-4 text-sm rounded-l-none">æ›´æ–°</button>
                    </div>
                </div>

                <div class="muji-card p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1">æ–°å¢ä¸€ç­†æ”¯å‡º</h3>
                    <div class="space-y-3">
                        <label for="item-input" class="block text-sm font-medium text-gray-700">å“é …åç¨±</label>
                        <input type="text" id="item-input" placeholder="ä¾‹å¦‚ï¼šæ™šé¤-ä¸€è˜­æ‹‰éºµ"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">

                        <label for="jpy-input" class="block text-sm font-medium text-gray-700">æ—¥å¹£é‡‘é¡/ç®—å¼ (e.g. 500+200*3)</label>
                        <input type="text" id="jpy-input" placeholder="è«‹è¼¸å…¥æ—¥å¹£é‡‘é¡æˆ–ç®—å¼"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">
                        
                        <label for="receipt-image-label" class="block text-sm font-medium text-gray-700">æ”¶æ“šç…§ç‰‡ (é¸å¡«)</label>
                        <label for="receipt-image" id="receipt-image-label" class="muji-btn flex items-center justify-center p-2 cursor-pointer text-sm">
                            <i class="fas fa-camera mr-2"></i> ä¸Šå‚³æ”¶æ“šç¸®åœ– (å°‡è‡ªå‹•å£“ç¸®)
                        </label>
                        <input type="file" id="receipt-image" accept="image/*" class="hidden-file-input">
                    </div>
                    
                    <button id="calculate-btn" class="muji-btn w-full mt-4 py-2 font-semibold">è¨˜éŒ„æ”¯å‡º</button>
                </div>


                <h3 class="text-xl font-bold text-gray-800 mb-4 mt-6">ğŸ“Š æ”¯å‡ºç¸½è¨ˆèˆ‡æ˜ç´°</h3>
                <div class="muji-card p-5 mb-6 bg-var(--color-accent)/20">
                    <p class="text-lg font-bold text-gray-800 flex justify-between mb-1">
                        <span>æ—¥åœ“ç¸½è¨ˆ (JPY):</span>
                        <span class="text-red-600">${formatCurrency(totalJPY, 'JPY')}</span>
                    </p>
                    <p class="text-lg font-bold text-gray-800 flex justify-between">
                        <span>å°å¹£ç¸½è¨ˆ (TWD):</span>
                        <span class="text-blue-600">${formatCurrency(totalTWD, 'TWD')}</span>
                    </p>
                </div>

                <div class="muji-card">
                    ${entriesHtml || '<p class="p-4 text-center text-gray-500">ç›®å‰é‚„æ²’æœ‰è¨˜å¸³ç´€éŒ„ã€‚</p>'}
                </div>
            `;
        }
        
        // ====================================================================
        // LISTS é é¢ (ç•¥)
        // ====================================================================

        function saveChecklist() {
            saveToLS('checklistItems', checklistItems);
        }

        function renderListsPage() {
            const categories = [...new Set(checklistItems.map(item => item.category))];
            
            let checklistHtml = categories.map(category => {
                const items = checklistItems.filter(item => item.category === category);
                const listItemsHtml = items.map(item => `
                    <li class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0 group">
                        <div class="flex items-center">
                            <input type="checkbox" id="item-${item.id}" onchange="toggleChecklistItem(${item.id})" ${item.checked ? 'checked' : ''}
                                class="h-4 w-4 text-var(--color-primary) border-gray-300 rounded focus:ring-var(--color-primary) checked:bg-var(--color-primary)">
                            <label for="item-${item.id}" class="ml-3 text-base text-gray-800 ${item.checked ? 'line-through text-gray-400' : ''}">${item.text}</label>
                        </div>
                        <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editChecklistItem(${item.id})" class="text-gray-400 hover:text-blue-600">
                                <i class="fas fa-pencil-alt text-sm"></i>
                            </button>
                            <button onclick="deleteChecklistItem(${item.id})" class="text-gray-400 hover:text-red-600">
                                <i class="fas fa-times text-sm"></i>
                            </button>
                        </div>
                    </li>
                `).join('');

                return `
                    <div class="muji-card p-5 mb-5">
                        <h3 class="text-lg font-bold text-var(--color-primary) mb-3 border-b border-gray-100 pb-1">${category}</h3>
                        <ul class="divide-y divide-gray-50 -mx-3">
                            ${listItemsHtml}
                        </ul>
                    </div>
                `;
            }).join('');
            
            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ’ è¡Œå‰æ¸…å–® (LISTS)</h2>
                
                <div class="muji-card p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1">æ–°å¢æ‰“åŒ…é …ç›®</h3>
                    <div class="flex space-x-2 mb-3">
                        <input type="text" id="new-item-text" placeholder="é …ç›®åç¨±" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">
                        <input type="text" id="new-item-category" placeholder="åˆ†é¡ (e.g. è¡£ç‰©/è³¼ç‰©æ¸…å–®)" class="w-28 p-2 border border-gray-300 rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">
                    </div>
                    <button onclick="addChecklistItem()" class="muji-btn w-full py-2 font-semibold">æ–°å¢åˆ°æ¸…å–®</button>
                </div>

                ${checklistHtml}
            `;
        }

        window.toggleChecklistItem = function(id) {
            const item = checklistItems.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                saveChecklist();
                renderPage();
            }
        }

        window.addChecklistItem = function() {
            const text = document.getElementById('new-item-text').value.trim();
            const category = document.getElementById('new-item-category').value.trim() || 'é›œé …';

            if (text) {
                const newId = checklistItems.length > 0 ? Math.max(...checklistItems.map(i => i.id)) + 1 : 1;
                checklistItems.push({ id: newId, text: text, checked: false, category: category });
                saveChecklist();
                document.getElementById('new-item-text').value = '';
                document.getElementById('new-item-category').value = '';
                renderPage();
            }
        }

        window.deleteChecklistItem = function(id) {
            if (confirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®å—ï¼Ÿ")) {
                checklistItems = checklistItems.filter(i => i.id !== id);
                saveChecklist();
                renderPage();
            }
        }

        window.editChecklistItem = function(id) {
            const item = checklistItems.find(i => i.id === id);
            if (item) {
                const newText = prompt("ç·¨è¼¯é …ç›®å…§å®¹ï¼š", item.text);
                if (newText !== null && newText.trim() !== '') {
                    item.text = newText.trim();
                    const newCategory = prompt("ç·¨è¼¯é …ç›®åˆ†é¡ (e.g. è¡£ç‰©)ï¼š", item.category);
                    if (newCategory !== null) {
                        item.category = newCategory.trim() || 'é›œé …';
                    }
                    saveChecklist();
                    renderPage();
                }
            }
        }

        function bindListsEvents() {
            // Nothing to bind beyond inline handlers for now
        }

        // ====================================================================
        // INFO é é¢ (è³‡è¨Š/é‡è¨­ & ç¾é£Ÿæ¸…å–®)
        // ====================================================================

        function saveMemo() {
            memoContent = document.getElementById('memo-content').value;
            saveToLS('memoContent', memoContent);
        }

        /**
         * å‘¼å« Modal é€²è¡ŒäºŒæ¬¡ç¢ºèª (é˜²å‘†)
         */
        window.openResetConfirmModal = function() {
            document.getElementById('reset-confirm-modal').style.display = 'block';
        }

        window.closeResetConfirmModal = function() {
            document.getElementById('reset-confirm-modal').style.display = 'none';
        }

        /**
         * åŸ·è¡Œè³‡æ–™æ¸…é™¤
         */
        window.executeReset = function() {
            localStorage.clear();
            alert("æ‰€æœ‰æœ¬åœ°è³‡æ–™å·²æ¸…é™¤ã€‚é é¢å°‡é‡æ–°è¼‰å…¥ã€‚");
            closeResetConfirmModal(); // é—œé–‰ Modal
            window.location.reload();
        }

        function bindInfoEvents() {
            // ç¢ºä¿å…ƒç´ å­˜åœ¨å¾Œå†ç¶å®šäº‹ä»¶
            const memoTextarea = document.getElementById('memo-content');
            if (memoTextarea) {
                memoTextarea.onchange = saveMemo;
                memoTextarea.onkeyup = saveMemo;
            }
        }

        /**
         * æ¸²æŸ“ç¾é£Ÿæ¨è–¦æ¸…å–®
         */
        function renderFoodRecommendations() {
            const foodList = tripInfo.foodRecommendations;
            if (!foodList || foodList.length === 0) return '';

            let html = '<h3 class="text-2xl font-bold text-gray-800 mb-6 mt-8">ğŸœ æ¨è–¦ç¾é£Ÿæ¸…å–® (Food Recommendations)</h3>';

            // å°‡é …ç›®æŒ‰åŸå¸‚åˆ†çµ„
            const groupedByCity = foodList.reduce((acc, current) => {
                (acc[current.city] = acc[current.city] || []).push(current);
                return acc;
            }, {});

            for (const city in groupedByCity) {
                html += `
                    <div class="muji-card p-5 mb-5">
                        <h4 class="text-xl font-bold text-var(--color-primary) mb-3 border-b border-gray-100 pb-1">${city} ç¾é£Ÿæ¨è–¦</h4>
                `;
                groupedByCity[city].forEach(areaGroup => {
                    html += `
                        <div class="mb-3">
                            <p class="text-lg font-semibold text-gray-700 mt-2 mb-1">${areaGroup.area}</p>
                            <ul class="list-disc list-inside ml-2 text-gray-700 text-sm space-y-1">
                                ${areaGroup.items.map(item => {
                                    // ** æ–°å¢ Google Maps é€£çµ **
                                    const query = `æ—¥æœ¬ ${areaGroup.city} ${areaGroup.area} ${item}`;
                                    const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                                    
                                    return `<li>
                                                <i class="fas fa-utensils text-gray-400 mr-1"></i> 
                                                <a href="${mapLink}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium underline">${item}</a>
                                            </li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                });
                html += '</div>';
            }
            return html;
        }

        function renderInfoPage() {
            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">â„¹ï¸ æ‡‰ç”¨ç¨‹å¼è³‡è¨Š (INFO)</h2>
                
                <div class="muji-card p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1">å€‹äººå‚™å¿˜éŒ„ (Memo)</h3>
                    <textarea id="memo-content" rows="8" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary) resize-none">${memoContent}</textarea>
                    <p class="text-xs text-gray-500 mt-2">æ­¤è™•å…§å®¹æœƒè‡ªå‹•å„²å­˜ã€‚</p>
                </div>
                
                ${renderFoodRecommendations()}

                <div class="muji-card p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1">é—œæ–¼æœ¬æŒ‡å—</h3>
                    <p class="text-sm text-gray-700">ç‰ˆæœ¬ï¼š1.0 (æ¥µç°¡ç„¡å°é¢¨æ—…è¡Œ App)</p>
                    <p class="text-sm text-gray-700">è¨­è¨ˆç›®æ¨™ï¼šè¼•é‡åŒ–ã€è¦–è¦ºåŒ–ã€é«˜äº’å‹•æ€§çš„å–®é å¼æ—…éŠè¡Œç¨‹ç®¡ç†ã€‚</p>
                    <p class="xs text-gray-500 mt-3">ç•¶å‰ä½¿ç”¨è€… ID: ${userId}</p>
                </div>

                <div class="muji-card p-5 mb-6 border border-red-200 bg-red-50">
                    <h3 class="text-lg font-bold text-red-600 mb-3 border-b border-red-200 pb-1">ğŸ’£ æ•¸æ“šç®¡ç†èˆ‡é‡è¨­</h3>
                    <p class="text-sm text-gray-600 mb-3">æ‚¨çš„æ‰€æœ‰ç·¨è¼¯ï¼ˆè¡Œç¨‹ä¿®æ”¹ã€è¨˜å¸³ã€æ¸…å–®ç­‰ï¼‰éƒ½å„²å­˜åœ¨**ç€è¦½å™¨çš„æœ¬åœ°å„²å­˜**ä¸­ã€‚</p>
                    <button onclick="openResetConfirmModal()" class="muji-btn bg-red-500 hover:bg-red-600 w-full py-2 font-semibold">
                        <i class="fas fa-trash-alt mr-2"></i> æ¸…é™¤æ‰€æœ‰æœ¬åœ°è³‡æ–™ (é‡è¨­ç‚ºåˆå§‹ç‹€æ…‹)
                    </button>
                    <p class="text-xs text-red-500 mt-2 text-center">**è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯é€†ï¼Œå°‡ä¸Ÿå¤±æ‰€æœ‰å€‹äººåŒ–æ•¸æ“šï¼**</p>
                </div>
            `;
        }
        
        // ====================================================================
        // V. INITIALIZATION (ç•¥)
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // è¨­å®šä½¿ç”¨è€… ID é¡¯ç¤º
            document.getElementById('current-user-id').textContent = `ä½¿ç”¨è€… ID: ${userId}`;
            
            // ç¶å®šåº•éƒ¨å°èˆªåˆ—äº‹ä»¶
            document.querySelectorAll('.nav-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const newPage = e.currentTarget.dataset.page;
                    if (newPage) {
                        currentPage = newPage;
                        renderPage();
                    }
                });
            });

            // åˆå§‹æ¸²æŸ“é é¢
            renderPage();
        });

    </script>
</body>
</html>
