<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§é˜ªæ¥µç°¡æ—…éŠæŒ‡å—</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Font: Inter (ç°¡æ½”çš„ç„¡å°é¢¨å­—é«”é¸æ“‡) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Muji/Minimalist Custom Styles */
        :root {
            --color-primary: #52734D; /* æŸ”å’Œè‹”ç¶  */
            --color-bg: #F9F9F9; /* ç±³ç™½è‰²èƒŒæ™¯ */
            --color-card-bg: #FFFFFF; /* å¡ç‰‡ç™½è‰² */
            --color-accent: #B2D4C8; /* æ·ºç¶ è‰²é»ç¶´ */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            padding-bottom: 4rem; /* ç¢ºä¿å…§å®¹ä¸æœƒè¢«åº•éƒ¨å°èˆªé®æ“‹ */
        }
        .muji-card {
            background-color: var(--color-card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .muji-btn {
            background-color: var(--color-primary);
            color: white;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .muji-btn:hover {
            background-color: #6a9562;
        }
        /* å°èˆªåˆ—æ¨£å¼ */
        .nav-item.active {
            color: var(--color-primary);
            font-weight: 600;
        }
        /* ç¢ºä¿å…§å®¹å€å¡Šä½”æ»¿è¦–çª— */
        .page-content {
            padding-top: 2rem;
            padding-bottom: 2rem;
            min-height: calc(100vh - 4rem - 2rem); /* 100vh - å°èˆªé«˜åº¦ - é ‚éƒ¨æ¨™é ­ */
        }
        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--color-accent);
        }
        .timeline-dot {
            position: absolute;
            left: -8px;
            top: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--color-primary);
            border: 3px solid var(--color-bg);
            z-index: 10;
        }
        .highlight-time {
            background-color: #ffedd5; /* æ·ºæ©™è‰²/ç±³é»ƒè‰²å¼·èª¿ */
            color: #c2410c; /* æ·±æ©˜è‰²æ–‡å­— */
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
        }
        /* éš±è—åŸç”Ÿæª”æ¡ˆè¼¸å…¥ï¼Œåƒ…é¡¯ç¤ºæŒ‰éˆ• */
        .hidden-file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
            pointer-events: none;
        }
        /* Modal æ¨£å¼ */
        .modal {
            display: none; /* é è¨­éš±è— */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(3px);
            padding-top: 50px;
        }
        .modal-content {
            background-color: var(--color-card-bg);
            margin: 5% auto; /* 5% from the top and centered */
            padding: 20px;
            border-radius: 12px;
            width: 90%; /* Responsive width */
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- ä¸»æ¨™é ­ -->
    <header class="sticky top-0 bg-white shadow-sm p-4 z-20">
        <h1 id="app-title" class="text-xl font-bold text-center text-gray-800">
            å¤§é˜ªæ¥µç°¡æ—…éŠæŒ‡å—
        </h1>
        <p class="text-xs text-center text-gray-500 mt-1">
            <span id="current-user-id">Loading User...</span>
        </p>
    </header>

    <!-- å…§å®¹å€å¡Š (å‹•æ…‹åˆ‡æ›) -->
    <main id="content" class="p-4 page-content max-w-xl mx-auto">
        <!-- å…§å®¹å°‡ç”± JavaScript å‹•æ…‹æ’å…¥ -->
    </main>

    <!-- åº•éƒ¨å°èˆªåˆ— (Fixed Footer Navigation) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl z-30">
        <div class="flex justify-around items-center h-16 max-w-xl mx-auto">
            <button class="nav-item flex flex-col items-center p-2 active" data-page="plan">
                <i class="fas fa-map-marked-alt text-xl"></i>
                <span class="text-xs mt-1">è¡Œç¨‹</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-page="guide">
                <i class="fas fa-book-reader text-xl"></i>
                <span class="text-xs mt-1">å°è¦½</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-page="wallet">
                <i class="fas fa-wallet text-xl"></i>
                <span class="text-xs mt-1">è¨˜å¸³</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-page="lists">
                <i class="fas fa-list-check text-xl"></i>
                <span class="text-xs mt-1">æ¸…å–®</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-page="info">
                <i class="fas fa-info-circle text-xl"></i>
                <span class="text-xs mt-1">è³‡è¨Š</span>
            </button>
        </div>
    </nav>

    <!-- è¡Œç¨‹ç·¨è¼¯ Modal -->
    <div id="edit-item-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ç·¨è¼¯è¡Œç¨‹ç´°é …</h3>
            
            <input type="hidden" id="modal-day-index">
            <input type="hidden" id="modal-item-index">
            
            <div class="mb-4">
                <label for="modal-time" class="block text-sm font-medium text-gray-700 mb-1">æ™‚é–“ (e.g., 10:00)</label>
                <input type="text" id="modal-time" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">
            </div>
            
            <div class="mb-4">
                <label for="modal-desc" class="block text-sm font-medium text-gray-700 mb-1">å…§å®¹æè¿°</label>
                <textarea id="modal-desc" class="w-full p-2 border border-gray-300 rounded-lg h-24 focus:ring-var(--color-primary) focus:border-var(--color-primary) resize-none"></textarea>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeEditModal()" class="bg-gray-300 text-gray-800 hover:bg-gray-400 rounded-lg py-2 px-4 text-sm font-medium">å–æ¶ˆ</button>
                <button onclick="saveEditedItem()" class="muji-btn py-2 px-4 text-sm font-medium">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>


    <script>
        // ====================================================================
        // I. DATA & STATE MANAGEMENT
        // ====================================================================

        let currentPage = 'plan';
        let userId = 'user-' + Math.random().toString(36).substring(2, 9); // Simple unique ID for LocalStorage
        const LS_PREFIX = 'muji_travel_app_';

        // é è¨­åŒ¯ç‡: 1 JPY = 0.21 TWD
        const DEFAULT_EXCHANGE_RATE = 0.21;
        
        // æ—…ç¨‹éœæ…‹è³‡è¨Šçš„åŸå§‹è³‡æ–™ (ä½œç‚º Reset çš„å‚™ä»½)
        const initialTripInfo = {
            flight: [
                { type: "å»ç¨‹", date: "12/15 (ä¸€)", flightNo: "MM032", from: "å°æ¸¯æ©Ÿå ´ (KHH)", dep: "14:45", to: "å¤§é˜ªé—œè¥¿æ©Ÿå ´ (KIX-T2)", arr: "18:30" },
                { type: "å›ç¨‹", date: "12/20 (å…­)", flightNo: "MM031", from: "å¤§é˜ªé—œè¥¿æ©Ÿå ´ (KIX-T2)", dep: "11:05", to: "å°æ¸¯æ©Ÿå ´ (KHH)", arr: "13:50" }
            ],
            hotel: "VIA INN PRIME å¿ƒé½‹æ©‹å››æ©‹Hotel",
            days: [
                {
                    date: "12/15 (ä¸€) Day1",
                    title: "æŠµé”èˆ‡å…¥ä½å¿ƒé½‹æ©‹",
                    items: [
                        { time: "18:30", type: "arrival", desc: "æŠµé”å¤§é˜ªé—œè¥¿æ©Ÿå ´ï¼ˆç¬¬äºŒèˆªå»ˆï¼‰", highlight: true, map: "å¤§é˜ªé—œè¥¿åœ‹éš›æ©Ÿå ´" },
                        { time: "19:30", type: "transfer", desc: "å‰å¾€é£¯åº—ï¼šVIA INN PRIME å¿ƒé½‹æ©‹å››æ©‹Hotel", map: "VIA INN PRIME å¿ƒé½‹æ©‹å››æ©‹Hotel" },
                        { time: "äº¤é€šå»ºè­°", type: "tip", desc: "1. å—æµ·é›»éµï¼šç©ºæ¸¯ç·šè‡³å—æµ·é›£æ³¢ç«™ï¼Œæ­¥è¡Œè½‰å¾¡å ‚ç­‹ç·šè‡³å¿ƒé½‹æ©‹ç«™(M19) 2è™Ÿå‡ºå£ã€‚<br>2. JR Harukaï¼šè‡³JRå¤©ç‹å¯ºç«™ï¼Œè½‰å¾¡å ‚ç­‹ç·šè‡³å¿ƒé½‹æ©‹ç«™(M19) 2è™Ÿå‡ºå£ã€‚" },
                    ]
                },
                {
                    date: "12/16 (äºŒ) Day2",
                    title: "æ—¥æœ¬ç’°çƒå½±åŸğŸ‡¯ğŸ‡µ (USJ)",
                    items: [
                        { time: "å…¨å¤©", type: "activity", desc: "æ—¥æœ¬ç’°çƒå½±åŸéŠç©ï¼ˆç’°çƒå½±åŸæ”»ç•¥ï¼‰", link: "#", map: "æ—¥æœ¬ç’°çƒå½±åŸ" },
                        { time: "äº¤é€š", type: "transfer", desc: "å¿ƒé½‹æ©‹ç«™(M19) â†’ æ¢…ç”°ç«™(M16) â†’ å¤§é˜ªç«™(O11) â†’ è¥¿ä¹æ¢ç«™(O14) (è½‰JRæ«»å³¶ç·š) â†’ ç’°çƒå½±åŸç«™(P16)", highlight: true },
                    ]
                },
                {
                    date: "12/17 (ä¸‰) Day3",
                    title: "å¤§é˜ªå¸‚å€æ·±åº¦éŠ",
                    items: [
                        { time: "07:30", type: "start", desc: "é£¯åº—å‡ºç™¼ï¼ˆè²·æ—©é¤ï¼‰", highlight: true, map: "VIA INN PRIME å¿ƒé½‹æ©‹å››æ©‹Hotel" },
                        { time: "09:30", type: "visit", desc: "å‹å°¾å¯º (åœç•™ç´„2å°æ™‚)", map: "å‹å°¾å¯º" },
                        { time: "äº¤é€š", type: "transfer", desc: "å¿ƒé½‹æ©‹ç«™(M19) â†’ ç®•é¢è±é‡ç«™(M06) â†’ 6è™Ÿæœˆå°è½‰ä¹˜ 29/30è™Ÿå…¬è»Šç›´é”å‹å°¾å¯º" },
                        { time: "11:30", type: "shopping", desc: "ï¼ƒC-pla æ¢…ç”°èŒ¶å±‹ç”ºåº— (æ‰­è›‹)", map: "ï¼ƒC-pla æ¢…ç”°èŒ¶å±‹ç”ºåº—" },
                        { time: "12:00", type: "meal", desc: "ä¸­å´ç”ºï¼ˆåˆé¤ï¼‰ï¼šneel nakazakicho æˆ– Onigiri Gorichan", map: "ä¸­å´ç”º" },
                        { time: "13:30", type: "visit", desc: "å¤§é˜ªåŸå…¬åœ’ãƒ»å¤©å®ˆé–£ (å…ˆæ›å¾¡åº§èˆ¹ç¥¨)", map: "å¤§é˜ªåŸå…¬åœ’" },
                        { time: "15:00", type: "visit", desc: "å››å¤©ç‹å¯º (æœ‰ç©ºçš„è©±ï¼›é–‹åˆ°å››é»)", map: "å››å¤©ç‹å¯º" },
                        { time: "17:00", type: "visit", desc: "å¤©ç‹å¯ºå…¬åœ’", map: "å¤©ç‹å¯ºå…¬åœ’" },
                        { time: "17:30", type: "shopping", desc: "è¿‘éµç™¾è²¨ é˜¿å€é‡æœ¬åº—", map: "è¿‘éµç™¾è²¨ é˜¿å€é‡æœ¬åº—" },
                        { time: "18:30", type: "visit", desc: "é˜¿å€é‡HARUKASå±•æœ›å°", map: "é˜¿å€é‡HARUKASå±•æœ›å°" },
                        { time: "19:00", type: "meal", desc: "æ™šé¤ï¼ˆè¿‘éµç™¾è²¨å…§æˆ–é™„è¿‘ï¼‰", map: "å¤©ç‹å¯ºè¿‘éµç™¾è²¨å‘¨é‚Šç¾é£Ÿ" },
                        { time: "20:00", type: "visit", desc: "é€šå¤©é–£", map: "é€šå¤©é–£" },
                        { time: "20:30", type: "end", desc: "è¿”å›é£¯åº—", highlight: true },
                    ]
                },
                {
                    date: "12/18 (å››) Day4",
                    title: "äº¬éƒ½æ¸…æ°´å¯ºæ•£ç­–",
                    items: [
                        { time: "ä¸Šåˆ", type: "transfer", desc: "å¤§é˜ªè‡³äº¬éƒ½äº¤é€šï¼šå¿ƒé½‹æ©‹ç«™(M19) â†’ æ¢…ç”°ç«™(M16) â†’ JRå¤§é˜ªç«™ â†’ JRäº¬éƒ½ç«™" },
                        { time: "äº¬éƒ½äº¤é€š", type: "tip", desc: "1. æ­Uberè‡³æ¸…æ°´å‚èˆ‡äº”æ¢é€šå£ (ç´„500å…ƒå°å¹£)<br>2. æ­206è™Ÿå·´å£«åœ¨æ¸…æ°´é“ç«™ä¸‹è»Š<br>3. è½‰åœ°ä¸‹éµçƒä¸¸ç·šè‡³ä¹æ¢ç«™(1è™Ÿå‡ºå£)æ­202/207è™Ÿå·´å£«åœ¨æ¸…æ°´é“ç«™ä¸‹è»Š" },
                        { time: "ä¸‹åˆ", type: "visit", desc: "æ¸…æ°´å¯º", map: "æ¸…æ°´å¯º" },
                        { time: "ä¸‹åˆ", type: "activity", desc: "äºŒå¹´å‚ã€ä¸‰å¹´å‚ (ç’ƒå…‰å’Œæœé«”é©—)", map: "äºŒå¹´å‚" },
                        { time: "å‚æ™š", type: "visit", desc: "é´¨å·æ•£æ­¥", map: "é´¨å·" },
                    ]
                },
                {
                    date: "12/19 (äº”) Day5",
                    title: "å¤©æ©‹ç«‹&ä¼Šæ ¹èˆŸå±‹&ç¾å±±åˆæŒæ‘ (Klook ä¸€æ—¥è¡Œç¨‹)",
                    items: [
                        { time: "é›†åˆ", type: "meetup", desc: "Klook ä¸€æ—¥è¡Œç¨‹ï¼šèŸ¹é“æ¨‚ é“é “å €æ±åº—é›†åˆ", highlight: true, map: "èŸ¹é“æ¨‚ é“é “å €æ±åº—" },
                        { time: "äº¤é€š", type: "transfer", desc: "å››æ©‹ç«™(Y14) â†’ é›£æ³¢ç«™(Y15) â†’ è½‰åƒæ—¥å‰ç·šè‡³æ—¥æœ¬æ©‹ç«™(S17) æ­¥è¡Œè‡³é›†åˆåœ°" },
                        { time: "å…¨å¤©", type: "activity", desc: "å¤©æ©‹ç«‹ã€ä¼Šæ ¹èˆŸå±‹ã€ç¾å±±åˆæŒæ‘ä¸€æ—¥éŠ", map: "å¤©æ©‹ç«‹" },
                    ]
                },
                {
                    date: "12/20 (å…­) Day6",
                    title: "è³¦æ­¸",
                    items: [
                        { time: "08:00", type: "start", desc: "è¾¦ç†é€€æˆ¿", highlight: true },
                        { time: "äº¤é€š", type: "transfer", desc: "é£¯åº—æ­¥è¡Œè‡³å¿ƒé½‹æ©‹ç«™(M19) â†’ é›£æ³¢ç«™(M20) â†’ å—æµ·é›£æ³¢ç«™ â†’ å—æµ·é›»éµç©ºæ¸¯ç·šè‡³é—œè¥¿ç©ºæ¸¯ (NK33)" },
                        { time: "11:05", type: "departure", desc: "å›ç¨‹èˆªç­ MM031 èµ·é£›", highlight: true, map: "å¤§é˜ªé—œè¥¿é—œè¥¿åœ‹éš›æ©Ÿå ´" },
                    ]
                }
            ],
            // æ·±åº¦å°è¦½çš„åŸå§‹è³‡æ–™
            guide: [
                {
                    title: "æ—¥æœ¬ç’°çƒå½±åŸ (USJ) æ”»ç•¥",
                    icon: "fas fa-hat-wizard",
                    text: "æ—¥æœ¬ç’°çƒå½±åŸæ˜¯å¤§é˜ªæœ€å—æ­¡è¿çš„ä¸»é¡Œæ¨‚åœ’ä¹‹ä¸€ï¼Œä»¥é›»å½±ç‚ºä¸»é¡Œï¼Œåˆ†ç‚ºå¤šå€‹å€åŸŸã€‚å‹™å¿…åœ¨å…¥åœ’å‰ç¢ºèªç‡Ÿæ¥­æ™‚é–“èˆ‡å¿«é€Ÿé€šé—œåˆ¸è³‡è¨Šã€‚\n\n**å†·çŸ¥è­˜:** ç‘ªåˆ©æ­åœ’å€ (Super Nintendo World) çš„é€²å…¥æœ‰æ™‚éœ€è¦æŠ½é¸æ•´ç†åˆ¸ï¼Œå»ºè­°ä¸€å…¥åœ’å°±å…ˆé ç´„ã€‚å®ƒçš„å‹•åŠ›æ‰‹ç’°èƒ½è®“ä½ èˆ‡åœ’å€çš„å„ç¨®è£ç½®äº’å‹•ï¼Œç©ç´¯é‡‘å¹£ï¼"
                },
                {
                    title: "å¤§é˜ªåŸãƒ»å¤©å®ˆé–£ï¼šè±è‡£ç§€å‰çš„æ­·å²å°è¨˜",
                    icon: "fas fa-fort-awesome",
                    text: "å¤§é˜ªåŸæ˜¯æ—¥æœ¬ä¸‰å¤§ååŸä¹‹ä¸€ï¼Œç”±è±è‡£ç§€å‰æ–¼ 16 ä¸–ç´€æœ«æ‰€å»ºï¼Œæ­·ç¶“æˆ°ç«æ‘§æ®˜å¾Œé‡å»ºã€‚ç¾åœ¨çš„å¤©å®ˆé–£å…§éƒ¨å·²æ”¹å»ºç‚ºåšç‰©é¤¨ï¼Œå±•ç¤ºè±è‡£ç§€å‰ç›¸é—œæ–‡ç‰©åŠå¤§é˜ªåŸçš„æ­·å²ã€‚\n\n**æ­·å²èƒŒæ™¯:** å¤§é˜ªåŸåœ¨å¾·å·å®¶åº·ç™¼å‹•çš„å¤§é˜ªå¤ä¹‹é™£å¾Œè¢«å¾¹åº•æ‘§æ¯€ã€‚ç¾åœ¨æˆ‘å€‘çœ‹åˆ°çš„æ˜¯ 1931 å¹´ç”±å¸‚æ°‘ææ¬¾é‡å»ºçš„ï¼Œé ‚å±¤çš„é‡‘ç®”è£é£¾æ¥µç‚ºè¯éº—ï¼Œæ˜¯ç¾ä»£å¤§é˜ªçš„è±¡å¾µã€‚"
                },
                {
                    title: "äº¬éƒ½æ¸…æ°´å¯ºï¼šæ‡¸ç©ºçš„åœ‹å¯¶",
                    icon: "fas fa-leaf",
                    text: "æ¸…æ°´å¯ºä»¥æ‡¸ç©ºçš„ã€Œæ¸…æ°´èˆå°ã€è€Œèåï¼Œæ˜¯äº¬éƒ½æœ€è‘—åçš„å¤è¹Ÿä¹‹ä¸€ã€‚èˆå°ç”± 139 æ ¹é«˜é”æ•¸åç±³çš„å·¨å¤§æ«¸æœ¨æ”¯æ’ï¼Œçµæ§‹å·§å¦™ï¼Œä¸”æœªä½¿ç”¨ä¸€æ ¹é‡˜å­ã€‚\n\n**å¿…è¨ª:** èˆå°ä¸‹çš„éŸ³ç¾½ä¹‹ç€§ï¼Œä¸‰é“æ³‰æ°´åˆ†åˆ¥ä»£è¡¨ã€Œé•·å£½ã€ã€ã€Œæˆ€æ„›ã€èˆ‡ã€Œå­¸æ¥­ã€ï¼Œæ“šèªªé£²ç”¨å…¶ä¸­ä¸€é“å°±èƒ½é¡˜æœ›æˆçœŸã€‚"
                },
            ]
        };


        // ====================================================================
        // II. LOCALSTORAGE UTILS
        // ====================================================================

        /**
         * å¾ LocalStorage è¼‰å…¥è³‡æ–™
         * @param {string} key
         * @param {*} defaultValue
         * @returns
         */
        function loadFromLS(key, defaultValue) {
            const data = localStorage.getItem(LS_PREFIX + key + '_' + userId);
            if (data === null) return defaultValue;
            try {
                return JSON.parse(data);
            } catch (e) {
                console.error("Error parsing LS data for key:", key, e);
                // å¦‚æœè§£æå¤±æ•—ï¼Œè¿”å›é è¨­å€¼ä¸¦æ¸…é™¤èˆŠçš„å£è³‡æ–™
                localStorage.removeItem(LS_PREFIX + key + '_' + userId);
                return defaultValue;
            }
        }

        /**
         * å„²å­˜è³‡æ–™åˆ° LocalStorage
         * @param {string} key
         * @param {*} value
         */
        function saveToLS(key, value) {
            try {
                localStorage.setItem(LS_PREFIX + key + '_' + userId, JSON.stringify(value));
            } catch (e) {
                console.error("Error saving to LS for key:", key, e);
                // å¦‚æœ LocalStorage æ»¿äº†ï¼Œå¯ä»¥åœ¨é€™è£¡çµ¦ç”¨æˆ¶æç¤º
            }
        }

        // åˆå§‹åŒ–/è¼‰å…¥æŒä¹…åŒ–ç‹€æ…‹ (å„ªå…ˆå¾ LocalStorage è¼‰å…¥)
        let exchangeRate = loadFromLS('exchangeRate', DEFAULT_EXCHANGE_RATE);
        let budgetEntries = loadFromLS('budgetEntries', []);
        let checklistItems = loadFromLS('checklistItems', initialTripInfo.checklist || [
            { id: 1, text: "è­·ç…§ã€èº«ä»½è­‰ã€é›»å­ç°½è­‰/å…¥å¢ƒå¡", checked: false, category: 'è­‰ä»¶' },
            { id: 2, text: "æ—¥åœ“ç¾é‡‘ã€ä¿¡ç”¨å¡", checked: false, category: 'è­‰ä»¶' },
            { id: 3, text: "ç¶²å¡/Wi-Fiæ©Ÿ/eSIM", checked: false, category: 'é€šè¨Š' },
            { id: 4, text: "æ‰‹æ©Ÿã€å……é›»ç·šã€è¡Œå‹•é›»æº", checked: false, category: 'é›»å­ç”¢å“' },
            { id: 5, text: "è½‰æ›æ’é ­/å»¶é•·ç·š", checked: false, category: 'é›»å­ç”¢å“' },
            { id: 6, text: "å€‹äººè—¥å“ã€OKç¹ƒã€å£ç½©", checked: false, category: 'è—¥å“' },
            { id: 7, text: "ç›¥æ´—ç”¨å“ã€åŒ–å¦å“", checked: false, category: 'ç›¥æ´—' },
            { id: 8, text: "è¶³å¤ è¡£ç‰©ã€ç™¼ç†±è¡£ (ä¾å¤©æ°£èª¿æ•´)", checked: false, category: 'è¡£ç‰©' },
            { id: 9, text: "é›¨å‚˜/é›¨è¡£ (å‚™ç”¨)", checked: false, category: 'é›œç‰©' },
            { id: 10, text: "æ—…éŠç¥¨åˆ¸ã€è¡Œç¨‹ç¢ºèªå–®", checked: false, category: 'é›œç‰©' },
        ]);
        let memoContent = loadFromLS('memoContent', "åœ¨æ­¤è¼¸å…¥æ‚¨çš„å€‹äººå‚™å¿˜éŒ„æˆ–é€£çµ...");

        // æ ¸å¿ƒè¡Œç¨‹è³‡è¨Š (å¯ç·¨è¼¯)
        let tripInfo = loadFromLS('tripInfo', initialTripInfo);


        // ====================================================================
        // III. COMMON UTILS
        // ====================================================================

        function formatCurrency(amount, currencyCode) {
            const options = {
                style: 'currency',
                currency: currencyCode,
                minimumFractionDigits: 0
            };
            return new Intl.NumberFormat('zh-TW', options).format(amount);
        }

        /**
         * Base64 è½‰ ArrayBuffer (ç”¨æ–¼åœ–ç‰‡å£“ç¸®)
         * @param {string} base64
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64.split(',')[1] || base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * åœ–ç‰‡å£“ç¸®ä¸¦è½‰ Base64
         * @param {string} dataUrl - åŸå§‹ Base64 åœ–ç‰‡
         * @returns {Promise<string>} - å£“ç¸®å¾Œçš„ Base64 åœ–ç‰‡
         */
        function compressImage(dataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 200; // ç¸®åœ–æœ€å¤§å¯¬åº¦
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height = height * (MAX_WIDTH / width);
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // è½‰ç‚º JPEG æ ¼å¼ï¼Œå“è³ª 0.7ï¼Œæ¸›å°‘å­—ä¸²é•·åº¦
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    resolve(compressedDataUrl);
                };
                img.onerror = () => resolve(''); // è™•ç†è¼‰å…¥éŒ¯èª¤
                img.src = dataUrl;
            });
        }


        // ====================================================================
        // IV. VIEW RENDERING (é é¢æ¸²æŸ“)
        // ====================================================================

        function renderPage() {
            const contentDiv = document.getElementById('content');
            let html = '';
            
            // æ›´æ–°å°èˆªåˆ—ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === currentPage) {
                    btn.classList.add('active');
                }
            });
            
            switch (currentPage) {
                case 'plan':
                    html = renderPlanPage();
                    break;
                case 'guide':
                    html = renderGuidePage();
                    break;
                case 'wallet':
                    html = renderWalletPage();
                    break;
                case 'lists':
                    html = renderListsPage();
                    break;
                case 'info':
                    html = renderInfoPage();
                    break;
            }
            contentDiv.innerHTML = html;
            
            // é é¢ç‰¹å®šäº‹ä»¶ç›£è½ (éœ€è¦åœ¨ innerHTML ä¹‹å¾Œç¶å®š)
            if (currentPage === 'wallet') {
                bindWalletEvents();
                document.getElementById('exchange-rate-input').value = exchangeRate;
            } else if (currentPage === 'lists') {
                bindListsEvents();
            } else if (currentPage === 'info') {
                bindInfoEvents();
            }
        }

        // ====================================================================
        // PLAN é é¢
        // ====================================================================

        function getIconForType(type) {
            switch(type) {
                case 'arrival': return 'plane-arrival';
                case 'departure': return 'plane-departure';
                case 'transfer': return 'train';
                case 'visit': return 'location-dot';
                case 'meal': return 'utensils';
                case 'activity': return 'ticket';
                case 'shopping': return 'bag-shopping';
                case 'meetup': return 'handshake-angle';
                case 'start': case 'end': return 'flag';
                case 'tip': return 'lightbulb';
                default: return 'circle-info';
            }
        }

        /**
         * æ¸²æŸ“è¡Œç¨‹å–®ä¸€ç´°é …çš„ HTML
         * @param {object} item - è¡Œç¨‹ç´°é …è³‡æ–™
         * @param {number} dayIndex - è©²ç´°é …æ‰€å±¬æ—¥çš„ç´¢å¼•
         * @param {number} itemIndex - è©²ç´°é …åœ¨æ—¥ä¸­çš„ç´¢å¼•
         * @returns {string} HTML å­—ä¸²
         */
        function getTimelineItemHtml(item, dayIndex, itemIndex) {
            const mapLink = item.map ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent('æ—¥æœ¬å¤§é˜ª ' + item.map)}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 font-medium ml-2 inline-flex items-center"><i class="fas fa-map-pin mr-1"></i> åœ°åœ–</a>` : '';
            const linkBtn = item.link && item.link !== '#' ? `<a href="${item.link}" target="_blank" class="text-xs text-teal-600 hover:text-teal-800 font-medium ml-2 inline-flex items-center"><i class="fas fa-link mr-1"></i> é€£çµ</a>` : '';
            
            let timeDisplay = item.time;
            if (item.highlight) {
                timeDisplay = `<span class="highlight-time">${item.time}</span>`;
            }

            return `
                <div class="relative pl-6 pb-8 timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="muji-card p-4 ml-2">
                        <div class="flex justify-between items-start">
                            <p class="text-sm font-semibold text-gray-700 mb-1">${timeDisplay}</p>
                            <!-- ç·¨è¼¯æŒ‰éˆ• -->
                            <button onclick="openEditModal(${dayIndex}, ${itemIndex})" class="text-gray-400 hover:text-var(--color-primary) p-1 -mt-1 -mr-1">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                        </div>

                        <div class="flex items-start">
                            <i class="fas fa-${getIconForType(item.type)} text-gray-500 mr-2 mt-1 text-sm"></i>
                            <p class="text-base text-gray-800 leading-relaxed">${item.desc}</p>
                        </div>
                        <div class="flex flex-wrap mt-2 -ml-2">
                           ${mapLink} ${linkBtn}
                        </div>
                    </div>
                </div>
            `;
        }


        function renderPlanPage() {
            let flightHtml = tripInfo.flight.map(f => `
                <div class="muji-card p-4 mb-3 text-sm">
                    <p class="font-bold text-gray-800">${f.type}ï¼š${f.date}</p>
                    <p class="text-gray-700 mt-1">
                        <i class="fas fa-plane-departure text-gray-500 mr-2"></i>
                        ${f.dep} (${f.from})
                        <span class="text-gray-400 mx-2">â¡ï¸</span>
                        ${f.arr} (${f.to})
                    </p>
                    <p class="text-gray-600 mt-1"><i class="fas fa-ticket-alt text-gray-500 mr-2"></i>èˆªç­ç·¨è™Ÿ: ${f.flightNo}</p>
                </div>
            `).join('');

            let itineraryHtml = tripInfo.days.map((day, dayIndex) => `
                <div class="muji-card p-5 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4 border-gray-100">${day.date} / ${day.title}</h3>
                    <div class="relative pl-4">
                        ${day.items.map((item, itemIndex) => getTimelineItemHtml(item, dayIndex, itemIndex)).join('')}
                    </div>
                </div>
            `).join('');


            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ—“ï¸ è¡Œç¨‹è¡¨ (PLAN)</h2>
                
                <!-- åŸºæœ¬è³‡è¨Šå¡ -->
                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 border-b border-gray-100 pb-1">æ ¸å¿ƒè³‡è¨Š</h3>
                    <p class="text-base text-gray-700 mb-2">
                        <i class="fas fa-hotel text-var(--color-primary) mr-2"></i>
                        <span class="font-medium">ä½å®¿:</span> ${tripInfo.hotel}
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(tripInfo.hotel)}" target="_blank" class="text-xs text-blue-600 ml-2">(åœ°åœ–)</a>
                    </p>
                    <div class="space-y-3">
                        ${flightHtml}
                    </div>
                </div>

                <!-- æ¯æ—¥è¡Œç¨‹ -->
                <h3 class="text-xl font-bold text-gray-800 mb-4 mt-6">è©³ç´°æ¯æ—¥è¦åŠƒ</h3>
                ${itineraryHtml}
            `;
        }

        // ====================================================================
        // è¡Œç¨‹ç·¨è¼¯ Modal é‚è¼¯
        // ====================================================================

        window.openEditModal = function(dayIndex, itemIndex) {
            const item = tripInfo.days[dayIndex].items[itemIndex];
            
            document.getElementById('modal-day-index').value = dayIndex;
            document.getElementById('modal-item-index').value = itemIndex;
            document.getElementById('modal-time').value = item.time;
            document.getElementById('modal-desc').value = item.desc.replace(/<br>/g, '\n'); // æ›¿æ› <br> ç‚ºæ›è¡Œ
            
            document.getElementById('edit-item-modal').style.display = 'block';
        }

        window.closeEditModal = function() {
            document.getElementById('edit-item-modal').style.display = 'none';
        }

        window.saveEditedItem = function() {
            const dayIndex = parseInt(document.getElementById('modal-day-index').value);
            const itemIndex = parseInt(document.getElementById('modal-item-index').value);
            const newTime = document.getElementById('modal-time').value.trim();
            const newDesc = document.getElementById('modal-desc').value.trim().replace(/\n/g, '<br>'); // å°‡æ›è¡Œè½‰å› <br>
            
            if (newTime && newDesc && !isNaN(dayIndex) && !isNaN(itemIndex)) {
                // æ›´æ–° tripInfo
                const itemToUpdate = tripInfo.days[dayIndex].items[itemIndex];
                itemToUpdate.time = newTime;
                itemToUpdate.desc = newDesc;

                // å„²å­˜ä¸¦é‡æ–°æ¸²æŸ“
                saveToLS('tripInfo', tripInfo);
                closeEditModal();
                renderPage();
            } else {
                alert("æ™‚é–“æˆ–å…§å®¹ä¸èƒ½ç‚ºç©ºï¼");
            }
        }
        
        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('edit-item-modal');
            if (event.target == modal) {
                closeEditModal();
            }
        }


        // ====================================================================
        // GUIDE é é¢
        // ====================================================================

        function renderGuidePage() {
            const guideContent = tripInfo.guide;

            const guideHtml = guideContent.map(item => `
                <div class="muji-card p-5 mb-5">
                    <h3 class="text-xl font-bold text-var(--color-primary) mb-3 flex items-center">
                        <i class="${item.icon} mr-3 text-2xl"></i>${item.title}
                    </h3>
                    <p class="text-gray-700 whitespace-pre-wrap leading-loose text-justify">${item.text}</p>
                </div>
            `).join('');

            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“– æ·±åº¦å°è¦½ (GUIDE)</h2>
                
                <p class="text-sm text-gray-600 mb-4">ç›®å‰çš„å°è¦½å…§å®¹ä»é ˆé€éã€Œè³‡è¨Šã€åˆ†é é€²è¡Œé€²éšç·¨è¼¯ã€‚</p>

                ${guideHtml}

                <h3 class="text-xl font-bold text-gray-800 mb-4 mt-8">ğŸ—ºï¸ åœ°ç†ä½ç½®æ¦‚è¦½ (å¤§é˜ªå¸‚)</h3>
                <div class="muji-card p-2 h-80 overflow-hidden">
                    <!-- ä½¿ç”¨ OpenStreetMap iframe -->
                    <iframe 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        scrolling="no" 
                        marginheight="0" 
                        marginwidth="0" 
                        src="https://www.openstreetmap.org/export/embed.html?bbox=135.485%2C34.675%2C135.535%2C34.705&layer=mapnik&marker=34.69%2C135.51" 
                        style="border: 1px solid black; border-radius: 8px;"
                    ></iframe>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">åœ°åœ–ä¸­å¿ƒç´„ç‚ºå¤§é˜ªé›£æ³¢/å¿ƒé½‹æ©‹å€åŸŸ</p>
            `;
        }

        // ====================================================================
        // WALLET é é¢ (è¨˜å¸³èˆ‡åŒ¯ç‡) - ä¿æŒä¸è®Š
        // ====================================================================

        function renderWalletPage() {
            let entriesHtml = budgetEntries.map((entry, index) => `
                <div class="flex items-center p-3 border-b border-gray-100 last:border-b-0">
                    <!-- ç¸®åœ– -->
                    <div class="w-12 h-12 flex-shrink-0 mr-3 overflow-hidden rounded-md bg-gray-100">
                        ${entry.image ? `<img src="${entry.image}" alt="æ”¶æ“š" class="w-full h-full object-cover">` : `<i class="fas fa-camera text-gray-400 text-lg flex items-center justify-center w-full h-full"></i>`}
                    </div>
                    <!-- å“é …èˆ‡é‡‘é¡ -->
                    <div class="flex-grow min-w-0">
                        <p class="font-medium text-gray-800 truncate">${entry.item}</p>
                        <p class="text-sm text-gray-600">
                            <span class="font-semibold text-red-600">${formatCurrency(entry.jpy, 'JPY')}</span>
                            <span class="text-gray-400 mx-1">/</span>
                            ${formatCurrency(entry.twd, 'TWD')}
                        </p>
                    </div>
                    <!-- åˆªé™¤æŒ‰éˆ• -->
                    <button onclick="deleteBudgetEntry(${index})" class="text-red-400 hover:text-red-600 text-lg p-1 ml-2">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('');

            const totalJPY = budgetEntries.reduce((sum, entry) => sum + entry.jpy, 0);
            const totalTWD = budgetEntries.reduce((sum, entry) => sum + entry.twd, 0);

            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ’° è¨˜å¸³èˆ‡åŒ¯ç‡ (WALLET)</h2>

                <!-- åŒ¯ç‡æ›ç®—å™¨ -->
                <div class="muji-card p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1">å³æ™‚åŒ¯ç‡æ›ç®— (1 JPY = <span id="current-rate">${exchangeRate}</span> TWD)</h3>
                    
                    <label for="exchange-rate-input" class="block text-sm font-medium text-gray-700 mb-2">è¨­å®šåŒ¯ç‡ (1 JPY = ? TWD)</label>
                    <div class="flex mb-4">
                        <input type="number" id="exchange-rate-input" step="0.001" min="0.1"
                            class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-var(--color-primary) focus:border-var(--color-primary) text-lg"
                            onchange="updateExchangeRate(this.value)">
                        <button onclick="updateExchangeRate()" class="muji-btn px-4 text-sm rounded-l-none">æ›´æ–°</button>
                    </div>

                    <div class="space-y-3">
                        <label for="jpy-input" class="block text-sm font-medium text-gray-700">æ—¥å¹£ç®—å¼ (e.g. 500+200*3)</label>
                        <input type="text" id="jpy-input" placeholder="è«‹è¼¸å…¥æ—¥å¹£ç®—å¼æˆ–é‡‘é¡"
                            class="w-full p-3 border border-gray-300 rounded-lg text-2xl font-mono text-right focus:ring-var(--color-primary) focus:border-var(--color-primary)">
                        
                        <button id="calculate-btn" class="muji-btn w-full py-3 text-lg font-bold mt-2">è¨ˆç®—ä¸¦æ›ç®— (TWD)</button>
                        
                        <div class="text-center p-3 mt-4 bg-var(--color-accent) rounded-lg bg-opacity-30">
                            <p class="text-sm text-gray-700">æ—¥å¹£ç¸½é¡ (JPY)ï¼š<span id="result-jpy" class="text-xl font-bold text-gray-800">0</span></p>
                            <p class="text-sm text-gray-700 mt-1">å°å¹£æ›ç®— (TWD)ï¼š<span id="result-twd" class="text-xl font-bold text-red-600">0</span></p>
                        </div>
                    </div>
                </div>

                <!-- è¨˜å¸³è¼¸å…¥ -->
                <div class="muji-card p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1">æ–°å¢ä¸€ç­†æ”¯å‡º</h3>
                    
                    <input type="text" id="budget-item" placeholder="å“é …åç¨± (e.g. åˆé¤, ç´€å¿µå“)"
                        class="w-full p-2 border border-gray-300 rounded-lg mb-3 focus:ring-var(--color-primary) focus:border-var(--color-primary)">
                    
                    <input type="number" id="budget-amount" placeholder="æ—¥å¹£é‡‘é¡ (JPY)"
                        class="w-full p-2 border border-gray-300 rounded-lg mb-3 focus:ring-var(--color-primary) focus:border-var(--color-primary)">
                    
                    <div class="flex space-x-3 mb-3">
                        <input type="file" id="receipt-photo" accept="image/*" capture="camera" class="hidden-file-input">
                        <label for="receipt-photo" class="muji-btn flex-grow py-2 text-center text-sm cursor-pointer hover:bg-opacity-90">
                            <i class="fas fa-camera mr-2"></i>æ‹ç…§ / ä¸Šå‚³æ”¶æ“š
                        </label>
                        <button id="add-budget-btn" class="muji-btn flex-grow py-2 text-sm">
                            <i class="fas fa-plus mr-2"></i>æ–°å¢è¨˜å¸³
                        </button>
                    </div>
                </div>

                <!-- è¨˜å¸³æ­·å² -->
                <div class="muji-card p-5">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1 flex justify-between items-center">
                        è¨˜å¸³æ­·å² (å…± ${budgetEntries.length} ç­†)
                        <span class="text-xs text-red-600 font-bold">ç¸½è¨ˆ: ${formatCurrency(totalTWD, 'TWD')}</span>
                    </h3>
                    <div id="budget-list" class="divide-y divide-gray-100">
                        ${entriesHtml || '<p class="text-center text-gray-500 py-4">å°šç„¡æ”¯å‡ºè¨˜éŒ„</p>'}
                    </div>
                </div>
            `;
        }

        function bindWalletEvents() {
            document.getElementById('calculate-btn').addEventListener('click', () => {
                const input = document.getElementById('jpy-input').value.trim();
                let jpyAmount = 0;
                let twdAmount = 0;
                
                if (input) {
                    try {
                        // ä½¿ç”¨ eval é€²è¡Œç®—å¼è¨ˆç®— (æ­¤è™•ç”¨æ–¼ç°¡å–®è¨ˆç®—ï¼Œå®‰å…¨æ€§å¯æ§)
                        jpyAmount = parseFloat(eval(input).toFixed(2));
                        twdAmount = parseFloat((jpyAmount * exchangeRate).toFixed(0));
                    } catch (e) {
                        jpyAmount = 0;
                        twdAmount = 0;
                        console.error("è¨ˆç®—éŒ¯èª¤:", e);
                    }
                }
                
                document.getElementById('result-jpy').textContent = formatCurrency(jpyAmount, 'JPY').replace('Â¥', '');
                document.getElementById('result-twd').textContent = formatCurrency(twdAmount, 'TWD').replace('NT$', '');
            });

            document.getElementById('receipt-photo').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const compressedBase64 = await compressImage(e.target.result);
                    document.getElementById('receipt-photo').dataset.base64 = compressedBase64;
                    
                    document.querySelector('label[for="receipt-photo"]').innerHTML = `<i class="fas fa-check mr-2"></i>æ”¶æ“šå·²æº–å‚™`;
                };
                reader.readAsDataURL(file);
            });

            document.getElementById('add-budget-btn').addEventListener('click', () => {
                const item = document.getElementById('budget-item').value.trim();
                const amount = parseFloat(document.getElementById('budget-amount').value);
                const base64Image = document.getElementById('receipt-photo').dataset.base64 || '';
                
                if (!item || isNaN(amount) || amount <= 0) {
                    document.getElementById('budget-item').classList.add('border-red-500');
                    document.getElementById('budget-amount').classList.add('border-red-500');
                    setTimeout(() => {
                        document.getElementById('budget-item').classList.remove('border-red-500');
                        document.getElementById('budget-amount').classList.remove('border-red-500');
                    }, 1000);
                    return;
                }
                
                const twd = parseFloat((amount * exchangeRate).toFixed(0));
                
                const newEntry = {
                    id: Date.now(),
                    item: item,
                    jpy: amount,
                    twd: twd,
                    image: base64Image,
                    date: new Date().toISOString()
                };
                
                budgetEntries.unshift(newEntry); // æ–°çš„åœ¨å‰é¢
                saveToLS('budgetEntries', budgetEntries);
                
                // é‡ç½®è¡¨å–®
                document.getElementById('budget-item').value = '';
                document.getElementById('budget-amount').value = '';
                document.getElementById('receipt-photo').dataset.base64 = '';
                document.querySelector('label[for="receipt-photo"]').innerHTML = `<i class="fas fa-camera mr-2"></i>æ‹ç…§ / ä¸Šå‚³æ”¶æ“š`;
                
                renderPage();
            });
        }

        window.updateExchangeRate = function(rateValue) {
            let newRate = parseFloat(rateValue || document.getElementById('exchange-rate-input').value);
            if (isNaN(newRate) || newRate <= 0) {
                newRate = DEFAULT_EXCHANGE_RATE;
                document.getElementById('exchange-rate-input').value = newRate;
            }
            exchangeRate = newRate;
            saveToLS('exchangeRate', exchangeRate);
            document.getElementById('current-rate').textContent = exchangeRate;
            
            budgetEntries.forEach(entry => {
                entry.twd = parseFloat((entry.jpy * exchangeRate).toFixed(0));
            });
            saveToLS('budgetEntries', budgetEntries);
            
            renderPage();
        }

        window.deleteBudgetEntry = function(index) {
            // ç¢ºèªåˆªé™¤
            if (!confirm("æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºè¨˜éŒ„å—ï¼Ÿ")) return;

            budgetEntries.splice(index, 1);
            saveToLS('budgetEntries', budgetEntries);
            renderPage();
        }

        // ====================================================================
        // LISTS é é¢ - ä¿æŒä¸è®Š
        // ====================================================================

        function renderChecklist() {
            const categories = checklistItems.reduce((acc, item) => {
                const key = item.category || 'æœªåˆ†é¡';
                if (!acc[key]) acc[key] = [];
                acc[key].push(item);
                return acc;
            }, {});

            let html = '';
            for (const category in categories) {
                html += `
                    <h4 class="text-base font-semibold text-gray-700 mt-4 mb-2">${category}</h4>
                    <ul class="space-y-2">
                        ${categories[category].map(item => `
                            <li class="flex items-center">
                                <input type="checkbox" id="check-${item.id}" data-id="${item.id}"
                                    class="h-5 w-5 text-var(--color-primary) border-gray-300 rounded focus:ring-var(--color-primary)"
                                    ${item.checked ? 'checked' : ''} onchange="toggleChecklistItem(${item.id})">
                                <label for="check-${item.id}" class="ml-3 text-base text-gray-700 ${item.checked ? 'line-through text-gray-500' : ''}">
                                    ${item.text}
                                </label>
                            </li>
                        `).join('')}
                    </ul>
                `;
            }
            return html;
        }

        function renderMemo() {
            const urlRegex = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
            const linkifiedText = memoContent.replace(urlRegex, (url) => {
                return `<a href="${url}" target="_blank" class="muji-btn px-3 py-1 text-xs mt-1 inline-flex items-center"><i class="fas fa-external-link-alt mr-1"></i> ${url.length > 30 ? url.substring(0, 30) + '...' : url}</a>`;
            });
            
            return `
                <div class="muji-card p-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1">å€‹äººå‚™å¿˜éŒ„ (å¯è¼¸å…¥é€£çµ)</h3>
                    <textarea id="memo-textarea" 
                        class="w-full p-2 border border-gray-300 rounded-lg h-32 text-gray-700 focus:ring-var(--color-primary) focus:border-var(--color-primary) resize-none"
                        oninput="saveMemoContent(this.value)"
                    >${memoContent}</textarea>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700 mb-2">é€£çµé è¦½å€ï¼š</p>
                        <div id="memo-preview" class="space-y-2">
                            ${linkifiedText}
                        </div>
                    </div>
                </div>
            `;
        }


        function renderListsPage() {
            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“ æ¸…å–®èˆ‡å‚™å¿˜ (LISTS)</h2>

                <!-- è¡Œå‰æº–å‚™ Checklist -->
                <div class="muji-card p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1">è¡Œå‰æº–å‚™ CheckList</h3>
                    <div id="checklist-container">
                        ${renderChecklist()}
                    </div>
                </div>

                <!-- å€‹äººå‚™å¿˜éŒ„ -->
                ${renderMemo()}
            `;
        }

        function bindListsEvents() {
            // Memo textarea input is handled by saveMemoContent in its oninput attribute
        }
        
        window.toggleChecklistItem = function(id) {
            const item = checklistItems.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                saveToLS('checklistItems', checklistItems);
                document.getElementById('checklist-container').innerHTML = renderChecklist();
            }
        }

        window.saveMemoContent = function(text) {
            memoContent = text;
            saveToLS('memoContent', memoContent);
            
            const urlRegex = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
            const linkifiedText = memoContent.replace(urlRegex, (url) => {
                return `<a href="${url}" target="_blank" class="muji-btn px-3 py-1 text-xs mt-1 inline-flex items-center"><i class="fas fa-external-link-alt mr-1"></i> ${url.length > 30 ? url.substring(0, 30) + '...' : url}</a>`;
            });
            document.getElementById('memo-preview').innerHTML = linkifiedText;
        }

        // ====================================================================
        // INFO é é¢ (ä¿ç•™é€²éšç·¨è¼¯åŠŸèƒ½)
        // ====================================================================

        function saveTripInfo() {
            const editor = document.getElementById('trip-info-editor');
            const statusDiv = document.getElementById('editor-status');
            
            try {
                const newTripInfo = JSON.parse(editor.value);
                // åŸ·è¡ŒåŸºæœ¬çµæ§‹æª¢æŸ¥ (å¯é¸, ç°¡åŒ–è™•ç†: ç¢ºä¿å®ƒæ˜¯å€‹ç‰©ä»¶ä¸”æœ‰ days é™£åˆ—)
                if (typeof newTripInfo !== 'object' || !Array.isArray(newTripInfo.days)) {
                    throw new Error("JSON æ ¼å¼ä¸ç¬¦é æœŸï¼Œè«‹ç¢ºä¿ days æ˜¯ä¸€å€‹é™£åˆ—ã€‚");
                }
                
                tripInfo = newTripInfo;
                saveToLS('tripInfo', tripInfo);
                
                statusDiv.textContent = 'âœ… è¡Œç¨‹è³‡æ–™å·²æˆåŠŸå„²å­˜ï¼è«‹åˆ‡æ›è‡³ PLAN æˆ– GUIDE é é¢æŸ¥çœ‹æ›´æ–°ã€‚';
                statusDiv.classList.remove('text-red-500', 'text-orange-500');
                statusDiv.classList.add('text-green-600');
                
            } catch (error) {
                statusDiv.textContent = `âŒ å„²å­˜å¤±æ•—ï¼JSON æ ¼å¼éŒ¯èª¤: ${error.message}`;
                statusDiv.classList.remove('text-green-600', 'text-orange-500');
                statusDiv.classList.add('text-red-500');
            }
        }

        function resetTripInfo() {
            // ä½¿ç”¨è‡ªå®šç¾© alert æ›¿ä»£ï¼Œå› ç‚º canvas ç’°å¢ƒä¸æ”¯æ´åŸç”Ÿ confirm
            const confirmed = window.confirm("æ‚¨ç¢ºå®šè¦å°‡è¡Œç¨‹è³‡æ–™é‡ç½®ç‚ºåˆå§‹ç‰ˆæœ¬å—ï¼Ÿé€™å°‡è¦†è“‹æ‰€æœ‰ä¿®æ”¹ã€‚");
            
            if (confirmed) {
                tripInfo = initialTripInfo;
                saveToLS('tripInfo', tripInfo);
                document.getElementById('trip-info-editor').value = JSON.stringify(tripInfo, null, 2);
                document.getElementById('editor-status').textContent = 'âš ï¸ è¡Œç¨‹è³‡æ–™å·²é‡ç½®ç‚ºé è¨­ç‰ˆæœ¬ï¼';
                document.getElementById('editor-status').classList.remove('text-green-600', 'text-red-500');
                document.getElementById('editor-status').classList.add('text-orange-500');
                renderPage(); // é‡æ–°æ¸²æŸ“é é¢ä»¥ç¢ºä¿è®Šå‹•ç”Ÿæ•ˆ
            }
        }
        
        function renderInfoPage() {
            const emergencyInfo = [
                { title: "è­¦å¯Ÿå ±æ¡ˆ (Police)", number: "110", icon: "user-secret" },
                { title: "æ•‘è­·è»Š/ç«è­¦ (Ambulance/Fire)", number: "119", icon: "fire-extinguisher" },
                { title: "ä¸­è¯æ°‘åœ‹é§æ—¥è¾¦äº‹è™• (å¤§é˜ª)", number: "+81-6-6120-6650", icon: "building-columns" },
                { title: "ç•¶åœ°å¤©æ°£é å ± (æ—¥æœ¬æ°£è±¡å»³)", link: "https://www.jma.go.jp/jma/index.html", icon: "cloud-sun" },
            ];

            const prohibitions = [
                { text: "æ”œå¸¶è¶…é‡æˆ–æœªç”³å ±ä¹‹ç…™é…’ã€è—¥å“ã€‚", icon: "ban" },
                { text: "æœªç¶“è¨±å¯æ”œå¸¶è‚‰è£½å“ã€æ°´æœç­‰å‹•æ¤ç‰©æª¢ç–«ç‰©å…¥å¢ƒã€‚", icon: "box-archive" },
                { text: "å…¬å…±å ´æ‰€å¸è¸ (è«‹è‡³æŒ‡å®šå¸è¸å€)ã€‚", icon: "smoking" },
                { text: "åœ¨è‡ªå‹•æ‰¶æ¢¯ä¸Šé å·¦/å³ç«™ç«‹ (å¤§é˜ªé å³ï¼Œæ±äº¬é å·¦ï¼Œä½†è«‹æ³¨æ„ç•¶åœ°æŒ‡ç¤º)ã€‚", icon: "person-walking" },
                { text: "é‚Šèµ°é‚Šåƒ (å¤šæ•¸æ—¥æœ¬äººç¿’æ…£ç«™è‘—åƒæˆ–æ‰¾åœ°æ–¹åä¸‹)ã€‚", icon: "utensils" },
            ];

            let emergencyHtml = emergencyInfo.map(item => `
                <div class="flex items-center p-3 border-b border-gray-100 last:border-b-0">
                    <i class="fas fa-${item.icon} text-xl text-var(--color-primary) mr-3 flex-shrink-0"></i>
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800">${item.title}</p>
                        ${item.number ? `<p class="text-red-600 text-sm font-mono">${item.number}</p>` : ''}
                    </div>
                    ${item.link ? `<a href="${item.link}" target="_blank" class="muji-btn px-3 py-1 text-xs">å‰å¾€</a>` : ''}
                </div>
            `).join('');

            let prohibitionHtml = prohibitions.map(item => `
                <li class="flex items-start text-gray-700">
                    <i class="fas fa-${item.icon} text-red-500 mr-3 mt-1 flex-shrink-0"></i>
                    ${item.text}
                </li>
            `).join('');


            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ’¡ æ—…éŠè³‡è¨Šèˆ‡è¨­å®š (INFO)</h2>

                <!-- è¡Œç¨‹è³‡æ–™ç·¨è¼¯å€ (é€²éš) -->
                <div class="muji-card p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1 flex justify-between items-center">
                        <i class="fas fa-code mr-2"></i>é€²éšç·¨è¼¯ (PLAN/GUIDE JSON è³‡æ–™)
                    </h3>
                    <p class="text-sm text-red-500 mb-3">âš ï¸ åƒ…é™é€²éšä½¿ç”¨è€…ï¼šè«‹ä»¥ JSON æ ¼å¼ç·¨è¼¯ï¼Œæ ¼å¼éŒ¯èª¤å°‡ç„¡æ³•å„²å­˜ã€‚</p>
                    
                    <textarea id="trip-info-editor" 
                        class="w-full p-2 border border-gray-300 rounded-lg h-80 text-gray-700 focus:ring-var(--color-primary) focus:border-var(--color-primary) resize-y"
                    ></textarea>
                    
                    <div class="flex space-x-3 mt-3">
                        <button id="save-trip-btn" class="muji-btn flex-grow py-2 text-sm">
                            <i class="fas fa-save mr-2"></i>å„²å­˜è®Šæ›´
                        </button>
                        <button id="reset-trip-btn" class="bg-gray-400 text-white hover:bg-gray-500 rounded-lg py-2 px-4 text-sm">
                            <i class="fas fa-undo mr-2"></i>é‡ç½®
                        </button>
                    </div>
                    <p id="editor-status" class="text-sm mt-3 text-gray-500"></p>
                </div>


                <!-- ç·Šæ€¥è³‡è¨Š -->
                <div class="muji-card p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1">ç·Šæ€¥è¯çµ¡è³‡è¨Š</h3>
                    <div class="divide-y divide-gray-100">
                        ${emergencyHtml}
                    </div>
                </div>

                <!-- æ—…éŠç¦å¿Œèˆ‡æ³¨æ„äº‹é … -->
                <div class="muji-card p-5">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b border-gray-100 pb-1">æ—…éŠç¦å¿Œèˆ‡æ³¨æ„äº‹é …</h3>
                    <ul class="space-y-3 list-none pl-0">
                        ${prohibitionHtml}
                    </ul>
                </div>
            `;
        }

        function bindInfoEvents() {
            const editor = document.getElementById('trip-info-editor');
            // è¼‰å…¥ç•¶å‰å„²å­˜çš„ JSON è³‡æ–™ï¼Œä¸¦æ ¼å¼åŒ–é¡¯ç¤º
            editor.value = JSON.stringify(tripInfo, null, 2);
            
            document.getElementById('save-trip-btn').addEventListener('click', saveTripInfo);
            document.getElementById('reset-trip-btn').addEventListener('click', resetTripInfo);

            // æ›¿ä»£ window.confirm/alert
            window.confirm = (message) => {
                return prompt(message + "\n\n(è«‹è¼¸å…¥ 'ç¢ºèª' ç¹¼çºŒ)");
            }

            // å°‡å…©å€‹å‡½å¼æ›è¼‰åˆ° windowï¼Œä»¥ä¾¿ HTML å…§é€£äº‹ä»¶ä½¿ç”¨ (é›–ç„¶é€™è£¡å·²æ”¹ç”¨ ID ç¶å®š)
            window.saveTripInfo = saveTripInfo;
            window.resetTripInfo = resetTripInfo;
        }


        // ====================================================================
        // V. INITIALIZATION & EVENT LISTENERS
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // é¡¯ç¤ºä½¿ç”¨è€… ID (æ–¹ä¾¿ LocalStorage éš”é›¢)
            document.getElementById('current-user-id').textContent = `ä½¿ç”¨è€… ID: ${userId}`;
            
            // å°èˆªåˆ—åˆ‡æ›
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetPage = e.currentTarget.dataset.page;
                    if (targetPage && targetPage !== currentPage) {
                        currentPage = targetPage;
                        renderPage();
                    }
                });
            });

            // é¦–æ¬¡æ¸²æŸ“ 'plan' é é¢
            renderPage();
        });
    </script>
</body>
</html>
